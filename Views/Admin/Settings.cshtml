@{
    Layout = "_LayoutAdmin";
    ViewBag.Title = "Cài Đặt";
}

<div class="page-content">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Cài Đặt Hệ Thống</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Menu cài đặt -->
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Menu Cài Đặt</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                                            <i class="bi bi-person-circle me-2"></i>Thông Tin Cá Nhân
                                        </a>
                                        <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="list">
                                            <i class="bi bi-shield-lock me-2"></i>Bảo Mật
                                        </a>
                                        <a href="#notification" class="list-group-item list-group-item-action" data-bs-toggle="list">
                                            <i class="bi bi-bell me-2"></i>Thông Báo
                                        </a>
                                        <a href="#system" class="list-group-item list-group-item-action" data-bs-toggle="list">
                                            <i class="bi bi-gear me-2"></i>Cài Đặt Hệ Thống
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nội dung cài đặt -->
                        <div class="col-md-9">
                            <div class="tab-content">
                                <!-- Thông tin cá nhân -->
                                <div class="tab-pane fade show active" id="profile">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Thông Tin Cá Nhân</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="adminProfileForm" enctype="multipart/form-data">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <div class="text-center">
                                                            <img id="adminAvatarPreview" src="~/assets/images/users/avatar-1.jpg" class="rounded-circle mb-3" width="150" height="150" alt="avatar">
                                                            <input type="file" name="ImageFile" id="adminImageFile" class="form-control mb-2" accept="image/*">
                                                            <input type="hidden" name="ImageUrl" id="adminImageUrl">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <div class="mb-3">
                                                            <label class="form-label">Họ và Tên</label>
                                                            <input type="text" class="form-control" name="FullName" id="adminFullName" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Email</label>
                                                            <input type="email" class="form-control" name="Email" id="adminEmail" readonly required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Số Điện Thoại</label>
                                                            <input type="tel" class="form-control" name="PhoneNumber" id="adminPhoneNumber" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Địa chỉ</label>
                                                            <input type="text" class="form-control" name="Address" id="adminAddress">
                                                        </div>
                                                    </div>
                                                </div>
                                                <fieldset>
                                                    <strong>Thay đổi mật khẩu</strong>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <label>Mật khẩu mới (để trống nếu không thay đổi):</label>
                                                            <input type="password" name="PasswordNew" id="adminPasswordNew" class="form-control mb-2">
                                                            <label>Xác nhận mật khẩu mới:</label>
                                                            <input type="password" name="ConfirmPassword" id="adminConfirmPassword" class="form-control">
                                                        </div>
                                                    </div>
                                                </fieldset>
                                                <div class="btn-wrapper mt-3">
                                                    <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bảo mật -->
                                <div class="tab-pane fade" id="security">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Bảo Mật</h5>
                                        </div>
                                        <div class="card-body">
                                            <form>
                                                <div class="mb-3">
                                                    <label class="form-label">Mật Khẩu Hiện Tại</label>
                                                    <input type="password" class="form-control">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Mật Khẩu Mới</label>
                                                    <input type="password" class="form-control">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Xác Nhận Mật Khẩu Mới</label>
                                                    <input type="password" class="form-control">
                                                </div>
                                                <button type="submit" class="btn btn-primary">Đổi Mật Khẩu</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Thông báo -->
                                <div class="tab-pane fade" id="notification">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Cài Đặt Thông Báo</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="emailNotif" checked>
                                                    <label class="form-check-label" for="emailNotif">Nhận thông báo qua Email</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="smsNotif">
                                                    <label class="form-check-label" for="smsNotif">Nhận thông báo qua SMS</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <h6 class="mb-2">Tần suất thông báo</h6>
                                                <select class="form-select">
                                                    <option value="realtime">Ngay lập tức</option>
                                                    <option value="daily">Hàng ngày</option>
                                                    <option value="weekly">Hàng tuần</option>
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-primary">Lưu Cài Đặt</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cài đặt hệ thống -->
                                <div class="tab-pane fade" id="system">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Cài Đặt Hệ Thống</h5>
                                        </div>
                                        <div class="card-body">
                                            <form>
                                                <div class="mb-3">
                                                    <label class="form-label">Ngôn Ngữ Hệ Thống</label>
                                                    <select class="form-select">
                                                        <option value="vi">Tiếng Việt</option>
                                                        <option value="en">English</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Múi Giờ</label>
                                                    <select class="form-select">
                                                        <option value="+7">GMT+7 (Việt Nam)</option>
                                                        <option value="+0">GMT+0 (UTC)</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Định Dạng Ngày Tháng</label>
                                                    <select class="form-select">
                                                        <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                                        <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="darkMode">
                                                        <label class="form-check-label" for="darkMode">Chế Độ Tối</label>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Lưu Cài Đặt</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import {BaseService} from "/Custom/BaseService.js";
import url from "/Custom/endpoints.js";
import Toast from "/Custom/Toast_Seller.js";

// Lấy token và id admin từ localStorage
const token = localStorage.getItem('accessToken');
const adminId = localStorage.getItem('id');

if (token && adminId) {
    const userUrl = url.base + "/Users";
    const baseService = new BaseService(userUrl, token);
    // Lấy thông tin admin
    baseService.fetchApi("/user-info?userId=" + adminId, 'POST', token).then(response => {
        if (response && response.success && response.data) {
            const userData = response.data;
            document.getElementById('adminFullName').value = userData.fullName || '';
            document.getElementById('adminEmail').value = userData.email || '';
            document.getElementById('adminPhoneNumber').value = userData.phoneNumber || '';
            document.getElementById('adminAddress').value = userData.address || '';
            document.getElementById('adminImageUrl').value = userData.imageUrl || '';
            // Hiển thị ảnh đại diện nếu có
            if (userData.imageUrl) {
                document.getElementById('adminAvatarPreview').src = `${url.baseUrl}/img/Users/${userData.imageUrl}`;
            }
        }
    }).catch(error => {
        console.error("Lỗi khi lấy thông tin admin:", error);
        Toast.error("Lỗi khi lấy thông tin admin!");
    });

    // Xử lý xem trước ảnh khi chọn file
    document.getElementById('adminImageFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('adminAvatarPreview').src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // Xử lý submit form
    document.getElementById('adminProfileForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const fullName = document.getElementById('adminFullName').value.trim();
        const email = document.getElementById('adminEmail').value.trim();
        const phoneNumber = document.getElementById('adminPhoneNumber').value.trim();
        const address = document.getElementById('adminAddress').value.trim();
        const passwordNew = document.getElementById('adminPasswordNew').value;
        const confirmPassword = document.getElementById('adminConfirmPassword').value;
        if (!fullName) { Toast.error("Vui lòng nhập họ và tên!"); return; }
        if (!email) { Toast.error("Vui lòng nhập email!"); return; }
        if (!phoneNumber) { Toast.error("Vui lòng nhập số điện thoại!"); return; }
        if (passwordNew && passwordNew !== confirmPassword) {
            Toast.error("Mật khẩu mới và xác nhận mật khẩu không khớp!");
            return;
        }
        const formData = new FormData();
        formData.append('Id', adminId);
        formData.append('FullName', fullName);
        formData.append('Email', email);
        formData.append('PhoneNumber', phoneNumber);
        formData.append('Address', address);
        formData.append('ImageUrl', document.getElementById('adminImageUrl').value);
        if (passwordNew) formData.append('PasswordNew', passwordNew);
        const imageFile = document.getElementById('adminImageFile').files[0];
        if (imageFile) formData.append('ImageFile', imageFile);
        baseService.fetchApi(`/${adminId}`, 'PUT', formData, true)
            .then(response => {
                if (response && response.success) {
                    Toast.success("Cập nhật thông tin thành công!");
                } else {
                    Toast.error(response?.message || "Cập nhật thông tin thất bại!");
                }
            })
            .catch(error => {
                console.error("Lỗi khi cập nhật thông tin:", error);
                Toast.error("Lỗi khi cập nhật thông tin!");
            });
    });
}
</script> 
    