@{
    Layout = "_LayoutAdmin";
}

<div class="page-content">

    <!-- Loading indicator -->
    <div id="loading-indicator" class="container-xxl">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6 text-center">
                <div class="card border-0 shadow-none">
                    <div class="card-body">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h4 class="fw-medium">Đang tải thông tin sản phẩm...</h4>
                        <p class="text-muted">Vui lòng đợi trong giây lát</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="container-xxl d-none">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6">
                <div class="card border-0 shadow">
                    <div class="card-body text-center p-5">
                        <div class="mb-4">
                            <i class="bx bx-check-circle text-success display-1"></i>
                        </div>
                        <h3>Cập nhật sản phẩm thành công!</h3>
                        <p class="text-muted">Thông tin sản phẩm đã được cập nhật vào hệ thống</p>
                        <div class="mt-4">
                            <button class="btn btn-primary me-2" id="view-product-btn">Xem sản phẩm</button>
                            <button class="btn btn-outline-primary" id="continue-edit-btn">Tiếp tục chỉnh sửa</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="container-xxl d-none">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6">
                <div class="card border-0 shadow">
                    <div class="card-body text-center p-5">
                        <div class="mb-4">
                            <i class="bx bx-error-circle text-danger display-1"></i>
                        </div>
                        <h3>Đã xảy ra lỗi!</h3>
                        <p id="error-text" class="text-muted">Không thể cập nhật sản phẩm, vui lòng thử lại sau.</p>
                        <div class="mt-4">
                            <button class="btn btn-primary" id="try-again-btn">Thử lại</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form Container -->
    <div id="form-container" class="container-xxl d-none">
        <div class="row">
            <div class="col-xl-3 col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <div class="product-image-preview text-center">
                            <img id="product-preview-image" src="assets/images/no-image.webp" alt="" class="img-fluid rounded bg-light">
                        </div>
                        <div class="mt-3">
                            <h4 id="product-preview-name">Tên sản phẩm</h4>
                            <h5 class="text-dark fw-medium mt-3">Giá:</h5>
                            <h4 class="fw-semibold text-dark mt-2 d-flex align-items-center gap-2" id="product-preview-price">
                                0 đ
                            </h4>
                            <div class="mt-3">
                                <h5 class="text-dark fw-medium">Đơn vị:</h5>
                                <div id="product-preview-unit" class="badge bg-primary-subtle text-primary">
                                    Đơn vị
                                </div>
                            </div>
                            <div class="mt-3">
                                <h5 class="text-dark fw-medium">Xuất xứ:</h5>
                                <div id="product-preview-origin" class="badge bg-info-subtle text-info">
                                    Xuất xứ
                                </div>
                            </div>
                            <div class="mt-3">
                                <h5 class="text-dark fw-medium">Trạng thái:</h5>
                                <div id="product-preview-status" class="badge bg-success-subtle text-success">
                                    Đang hoạt động
                                </div>
                            </div>
                        </div>
                    </div>                                  
                </div>
            </div>

            <div class="col-xl-9 col-lg-8">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <h4 class="card-title mb-0">Chỉnh Sửa Ảnh Sản Phẩm</h4>
                        <div>
                            <span class="badge bg-danger-subtle text-danger" id="image-error" style="display: none;">Vui lòng tải lên ảnh sản phẩm</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- File Upload -->
                        <form action="#" class="dropzone" id="productImageUpload">
                            <div class="fallback">
                                <input name="file" type="file" accept="image/*" />
                            </div>
                            <div class="dz-message needsclick">
                                <i class="bx bx-cloud-upload fs-48 text-primary"></i>
                                <h3 class="mt-4">Kéo thả ảnh mới vào đây, hoặc <span class="text-primary">click để chọn</span></h3>
                                <span class="text-muted fs-13">
                                    1600 x 1200 (4:3) được khuyến nghị. Chấp nhận file PNG, JPG và GIF
                                </span>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Thông Tin Sản Phẩm</h4>
                    </div>
                    <div class="card-body">
                        <form id="productForm">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-name" class="form-label">Tên Sản Phẩm <span class="text-danger">*</span></label>
                                        <input type="text" id="product-name" name="name" class="form-control" placeholder="Nhập tên sản phẩm" required>
                                        <div class="invalid-feedback">Vui lòng nhập tên sản phẩm</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-category" class="form-label">Danh Mục Sản Phẩm <span class="text-danger">*</span></label>
                                        <select class="form-select" id="product-category" name="categoryId" required>
                                            <option value="" disabled>Chọn danh mục</option>
                                            <!-- Danh mục sẽ được load từ API -->
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn danh mục sản phẩm</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-origin" class="form-label">Xuất Xứ <span class="text-danger">*</span></label>
                                        <select class="form-select" id="product-origin" name="origin" required>
                                            <option value="" disabled>Chọn xuất xứ</option>
                                            <!-- Xuất xứ sẽ được load từ API -->
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn xuất xứ sản phẩm</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-unit" class="form-label">Đơn Vị <span class="text-danger">*</span></label>
                                        <select class="form-select" id="product-unit" name="unit" required>
                                            <option value="" disabled>Chọn đơn vị</option>
                                            <!-- Đơn vị sẽ được load từ API -->
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn đơn vị sản phẩm</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label for="product-description" class="form-label">Mô Tả</label>
                                        <textarea class="form-control" id="product-description" name="description" rows="5" placeholder="Mô tả chi tiết về sản phẩm"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-price" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                                        <input type="number" id="product-price" name="price" class="form-control" placeholder="Nhập giá sản phẩm" min="0" required>
                                        <div class="invalid-feedback">Vui lòng nhập giá sản phẩm hợp lệ</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-stock" class="form-label">Số Lượng Tồn Kho <span class="text-danger">*</span></label>
                                        <input type="number" id="product-stock" name="stockQuantity" class="form-control" placeholder="Nhập số lượng" min="0" required>
                                        <div class="invalid-feedback">Vui lòng nhập số lượng tồn kho hợp lệ</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="product-active" name="isActive">
                                        <label class="form-check-label" for="product-active">Kích hoạt sản phẩm (sản phẩm sẽ hiển thị cho người dùng)</label>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="product-id" name="id" value="">
                            <input type="hidden" id="product-store-id" name="storeId" value="">
                            <input type="hidden" id="product-image-url" name="imageUrl" value="">
                            <input type="hidden" id="product-sold-quantity" name="soldQuantity" value="0">
                        </form>
                    </div>
                </div>
                <div class="p-3 bg-light mb-3 rounded">
                    <div class="row justify-content-end g-2">
                        <div class="col-lg-2">
                            <button type="button" class="btn btn-outline-secondary w-100" id="cancel-button">Hủy</button>
                        </div>
                        <div class="col-lg-2">
                            <button type="button" class="btn btn-primary w-100" id="save-button">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Container Fluid -->

    <!-- ========== Footer Start ========== -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 text-center">
                     &copy; VNFarm. Crafted by <iconify-icon icon="iconamoon:heart-duotone" class="fs-18 align-middle text-danger"></iconify-icon> <a
                        href="#" class="fw-bold footer-text" target="_blank">Hệ Thống Quản Lý Nông Sản VNFarm</a>
                </div>
            </div>
        </div>
    </footer>
    <!-- ========== Footer End ========== -->

</div>

<script type="module">
    import { BaseService } from "/custom/BaseService.js";
    import { EnumService } from "/custom/EnumService.js";
    import key from "/custom/jwt.js";
    import url from "/Custom/endpoints.js";

    const appProductEdit = {
        productId: null,
        categoryData: [],
        unitTypes: {},
        originTypes: [],
        dropzone: null,
        uploadedImage: null,
        originalData: null,
        
        init: function() {
            const jwt = key;
            const productUrl = url.base + "/Product";
            const categoryUrl = url.base + "/Category";
            const enumService = new EnumService(url.baseUrl, jwt);
            this.productService = new BaseService(productUrl, jwt);
            this.categoryService = new BaseService(categoryUrl, jwt);
            this.enumService = enumService;
            
            // Hiển thị loading
            this.toggleLoading(true);
            
            // Lấy id sản phẩm từ URL
            const urlParams = new URLSearchParams(window.location.search);
            this.productId = urlParams.get("id");
            
            if (!this.productId) {
                this.showError("Không tìm thấy ID sản phẩm, vui lòng kiểm tra lại đường dẫn");
                return;
            }
            
            // Khởi tạo Dropzone để upload ảnh
            this.initDropzone();
            
            // Tải dữ liệu danh mục, đơn vị, xuất xứ
            this.loadCategories();
            this.loadUnitTypes();
            this.loadOriginTypes();
            
            // Thiết lập các sự kiện cho form
            this.setupEventListeners();
        },
        
        // Hiển thị/ẩn trạng thái loading
        toggleLoading: function(isLoading) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const formContainer = document.getElementById('form-container');
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');
            
            if (isLoading) {
                loadingIndicator.classList.remove('d-none');
                formContainer.classList.add('d-none');
                successMessage.classList.add('d-none');
                errorMessage.classList.add('d-none');
            } else {
                loadingIndicator.classList.add('d-none');
                formContainer.classList.remove('d-none');
            }
        },
        
        // Hiển thị thông báo thành công
        showSuccess: function() {
            const formContainer = document.getElementById('form-container');
            const successMessage = document.getElementById('success-message');
            
            formContainer.classList.add('d-none');
            successMessage.classList.remove('d-none');
        },
        
        // Hiển thị thông báo lỗi
        showError: function(message) {
            const formContainer = document.getElementById('form-container');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            errorText.textContent = message || "Không thể cập nhật sản phẩm, vui lòng thử lại sau.";
            loadingIndicator.classList.add('d-none');
            formContainer.classList.add('d-none');
            errorMessage.classList.remove('d-none');
        },
        
        // Thiết lập Dropzone để upload ảnh
        initDropzone: function() {
            const self = this;
            
            this.dropzone = new Dropzone("#productImageUpload", {
                url: "/#", // URL giả để không tự động upload
                autoProcessQueue: false,
                maxFiles: 1,
                acceptedFiles: "image/*",
                addRemoveLinks: true,
                dictRemoveFile: "Xóa",
                dictDefaultMessage: "Kéo thả ảnh vào đây hoặc click để chọn",
                init: function() {
                    this.on("addedfile", function(file) {
                        // Nếu đã có file, xóa file cũ
                        if (this.files.length > 1) {
                            this.removeFile(this.files[0]);
                        }
                        
                        // Lưu file để sử dụng sau
                        self.uploadedImage = file;
                        
                        // Cập nhật preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('product-preview-image').src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        
                        // Ẩn thông báo lỗi nếu có
                        document.getElementById('image-error').style.display = 'none';
                    });
                    
                    this.on("removedfile", function() {
                        self.uploadedImage = null;
                        
                        // Khôi phục ảnh gốc nếu có
                        if (self.originalData && self.originalData.imageUrl) {
                            self.loadProductImage(self.originalData.imageUrl);
                        } else {
                            document.getElementById('product-preview-image').src = "assets/images/no-image.webp";
                        }
                    });
                }
            });
        },
        
        // Tải thông tin sản phẩm
        loadProductData: function() {
            const self = this;
            
            this.productService.getById(this.productId)
                .then(function(response) {
                    if (response && response.success && response.data) {
                        self.originalData = response.data;
                        self.populateForm(response.data);
                    } else {
                        self.showError("Không thể tải thông tin sản phẩm: " + (response?.message || "Không rõ lỗi"));
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi tải thông tin sản phẩm:", error);
                    self.showError("Đã xảy ra lỗi khi tải thông tin sản phẩm. Vui lòng thử lại sau.");
                })
                .finally(function() {
                    // Hoàn thành tải dữ liệu
                    self.toggleLoading(false);
                });
        },
        
        // Điền thông tin sản phẩm vào form
        populateForm: function(product) {
            // Điền thông tin cơ bản
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-description').value = product.description || "";
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stockQuantity;
            document.getElementById('product-store-id').value = product.storeId;
            document.getElementById('product-image-url').value = product.imageUrl || "";
            document.getElementById('product-sold-quantity').value = product.soldQuantity || 0;
            document.getElementById('product-active').checked = product.isActive;
            
            // Chọn danh mục
            const categorySelect = document.getElementById('product-category');
            if (categorySelect.querySelector(`option[value="${product.categoryId}"]`)) {
                categorySelect.value = product.categoryId;
            }
            
            // Chọn đơn vị
            const unitSelect = document.getElementById('product-unit');
            if (unitSelect.querySelector(`option[value="${product.unit}"]`)) {
                unitSelect.value = product.unit;
            }
            
            // Chọn xuất xứ
            const originSelect = document.getElementById('product-origin');
            if (originSelect.querySelector(`option[value="${product.origin}"]`)) {
                originSelect.value = product.origin;
            }
            
            // Cập nhật preview
            this.updatePreview(product);
            
            // Hiển thị ảnh sản phẩm
            if (product.imageUrl) {
                this.loadProductImage(product.imageUrl);
            }
        },
        
        // Tải ảnh sản phẩm
        loadProductImage: function(imageUrl) {
            this.productService.fetchImage(imageUrl, "Products")
                .then(url => {
                    document.getElementById('product-preview-image').src = url;
                })
                .catch(error => {
                    console.error("Lỗi khi tải ảnh sản phẩm:", error);
                    document.getElementById('product-preview-image').src = "assets/images/no-image.webp";
                });
        },
        
        // Cập nhật preview
        updatePreview: function(product) {
            document.getElementById('product-preview-name').textContent = product.name;
            document.getElementById('product-preview-price').textContent = this.formatCurrency(product.price);
            
            // Hiển thị đơn vị
            const unitText = this.unitTypes[product.unit] || "Không xác định";
            document.getElementById('product-preview-unit').textContent = unitText;
            
            // Hiển thị xuất xứ
            document.getElementById('product-preview-origin').textContent = product.origin || "Không xác định";
            
            // Hiển thị trạng thái
            const statusElement = document.getElementById('product-preview-status');
            if (product.isActive) {
                statusElement.textContent = "Đang hoạt động";
                statusElement.className = "badge bg-success-subtle text-success";
            } else {
                statusElement.textContent = "Ngừng hoạt động";
                statusElement.className = "badge bg-danger-subtle text-danger";
            }
        },
        
        // Tải danh sách danh mục
        loadCategories: function() {
            const self = this;
            const categorySelect = document.getElementById('product-category');
            
            this.categoryService.getAll()
                .then(function(response) {
                    if (response && response.success && response.data) {
                        self.categoryData = response.data;
                        
                        // Thêm các option vào select
                        response.data.forEach(function(category) {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        });
                        
                        // Tải sản phẩm sau khi đã tải danh mục
                        self.loadProductData();
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi tải danh mục:", error);
                    self.loadProductData(); // Vẫn tải sản phẩm ngay cả khi không tải được danh mục
                });
        },
        
        // Tải danh sách đơn vị
        loadUnitTypes: function() {
            const self = this;
            const unitSelect = document.getElementById('product-unit');
            
            this.enumService.getUnitTypes()
                .then(function(data) {
                    if (data) {
                        self.unitTypes = data;
                        
                        // Thêm các option vào select
                        Object.keys(data).forEach(function(key) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = data[key];
                            unitSelect.appendChild(option);
                        });
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi tải đơn vị:", error);
                });
        },
        
        // Tải danh sách xuất xứ
        loadOriginTypes: function() {
            const self = this;
            const originSelect = document.getElementById('product-origin');
            
            this.enumService.getOriginTypes()
                .then(function(data) {
                    if (data) {
                        self.originTypes = data;
                        
                        // Thêm các option vào select
                        data.forEach(function(origin) {
                            const option = document.createElement('option');
                            option.value = origin;
                            option.textContent = origin;
                            originSelect.appendChild(option);
                        });
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi tải xuất xứ:", error);
                });
        },
        
        // Thiết lập các sự kiện
        setupEventListeners: function() {
            const self = this;
            
            // Cập nhật preview khi thay đổi thông tin
            document.getElementById('product-name').addEventListener('input', function() {
                document.getElementById('product-preview-name').textContent = this.value;
            });
            
            document.getElementById('product-price').addEventListener('input', function() {
                document.getElementById('product-preview-price').textContent = self.formatCurrency(this.value);
            });
            
            document.getElementById('product-unit').addEventListener('change', function() {
                const unitText = self.unitTypes[this.value] || "Không xác định";
                document.getElementById('product-preview-unit').textContent = unitText;
            });
            
            document.getElementById('product-origin').addEventListener('change', function() {
                document.getElementById('product-preview-origin').textContent = this.value;
            });
            
            document.getElementById('product-active').addEventListener('change', function() {
                const statusElement = document.getElementById('product-preview-status');
                if (this.checked) {
                    statusElement.textContent = "Đang hoạt động";
                    statusElement.className = "badge bg-success-subtle text-success";
                } else {
                    statusElement.textContent = "Ngừng hoạt động";
                    statusElement.className = "badge bg-danger-subtle text-danger";
                }
            });
            
            // Nút Lưu
            document.getElementById('save-button').addEventListener('click', function() {
                self.saveProduct();
            });
            
            // Nút Hủy
            document.getElementById('cancel-button').addEventListener('click', function() {
                if (confirm('Bạn có chắc chắn muốn hủy các thay đổi?')) {
                    window.location.href = `/Admin/ProductList`;
                }
            });
            
            // Nút thử lại khi có lỗi
            document.getElementById('try-again-btn').addEventListener('click', function() {
                const formContainer = document.getElementById('form-container');
                const errorMessage = document.getElementById('error-message');
                
                errorMessage.classList.add('d-none');
                formContainer.classList.remove('d-none');
            });
            
            // Nút xem sản phẩm sau khi cập nhật thành công
            document.getElementById('view-product-btn').addEventListener('click', function() {
                window.location.href = `/Admin/ProductDetail?id=${self.productId}`;
            });
            
            // Nút tiếp tục chỉnh sửa
            document.getElementById('continue-edit-btn').addEventListener('click', function() {
                const formContainer = document.getElementById('form-container');
                const successMessage = document.getElementById('success-message');
                
                successMessage.classList.add('d-none');
                formContainer.classList.remove('d-none');
            });
        },
        
        // Validate form trước khi submit
        validateForm: function() {
            const form = document.getElementById('productForm');
            
            // Thêm class was-validated để hiển thị validation
            form.classList.add('was-validated');
            
            // Kiểm tra các trường bắt buộc
            const name = document.getElementById('product-name').value;
            const categoryId = document.getElementById('product-category').value;
            const origin = document.getElementById('product-origin').value;
            const unit = document.getElementById('product-unit').value;
            const price = document.getElementById('product-price').value;
            const stockQuantity = document.getElementById('product-stock').value;
            
            // Kiểm tra các trường khác
            if (!name || !categoryId || !origin || !unit || !price || !stockQuantity) {
                return false;
            }
            
            return true;
        },
        
        // Lưu sản phẩm
        saveProduct: function() {
            if (!this.validateForm()) {
                return;
            }
            
            const self = this;
            this.toggleLoading(true);
            
            // Chuẩn bị dữ liệu
            if (this.uploadedImage) {
                // Nếu có tải ảnh mới, sử dụng FormData
                const formData = new FormData();
                
                // Thêm các trường vào FormData
                formData.append('id', document.getElementById('product-id').value);
                formData.append('name', document.getElementById('product-name').value);
                formData.append('description', document.getElementById('product-description').value || "");
                formData.append('price', document.getElementById('product-price').value);
                formData.append('stockQuantity', document.getElementById('product-stock').value);
                formData.append('unit', document.getElementById('product-unit').value);
                formData.append('storeId', document.getElementById('product-store-id').value);
                formData.append('categoryId', document.getElementById('product-category').value);
                formData.append('origin', document.getElementById('product-origin').value);
                formData.append('isActive', document.getElementById('product-active').checked);
                formData.append('soldQuantity', document.getElementById('product-sold-quantity').value);
                
                // Thêm ảnh mới
                formData.append('imageFile', this.uploadedImage);
                
                // Gọi API cập nhật sản phẩm với FormData
                this.productService.update(this.productId, formData, true)
                    .then(this.handleUpdateResponse.bind(this))
                    .catch(this.handleUpdateError.bind(this));
            } else {
                // Nếu không có ảnh mới, sử dụng JSON
                const productData = {
                    id: parseInt(document.getElementById('product-id').value),
                    name: document.getElementById('product-name').value,
                    description: document.getElementById('product-description').value || "",
                    price: parseFloat(document.getElementById('product-price').value),
                    stockQuantity: parseInt(document.getElementById('product-stock').value),
                    unit: parseInt(document.getElementById('product-unit').value),
                    storeId: parseInt(document.getElementById('product-store-id').value),
                    categoryId: parseInt(document.getElementById('product-category').value),
                    origin: document.getElementById('product-origin').value,
                    isActive: document.getElementById('product-active').checked,
                    soldQuantity: parseInt(document.getElementById('product-sold-quantity').value),
                    imageUrl: document.getElementById('product-image-url').value
                };
                
                // Gọi API cập nhật sản phẩm với JSON
                this.productService.update(this.productId, productData)
                    .then(this.handleUpdateResponse.bind(this))
                    .catch(this.handleUpdateError.bind(this));
            }
        },
        
        // Xử lý phản hồi khi cập nhật sản phẩm
        handleUpdateResponse: function(response) {
            this.toggleLoading(false);
            
            if (response && response.success) {
                // Hiển thị thông báo thành công
                this.showSuccess();
                
                // Cập nhật dữ liệu gốc
                this.originalData = response.data;
                
                // Cập nhật URL ảnh nếu có
                if (response.data && response.data.imageUrl) {
                    document.getElementById('product-image-url').value = response.data.imageUrl;
                }
            } else {
                // Hiển thị thông báo lỗi
                this.showError(response?.message || "Không thể cập nhật sản phẩm");
            }
        },
        
        // Xử lý lỗi khi cập nhật sản phẩm
        handleUpdateError: function(error) {
            console.error("Lỗi khi cập nhật sản phẩm:", error);
            this.toggleLoading(false);
            this.showError(error.message || "Đã xảy ra lỗi khi cập nhật sản phẩm");
        },
        
        // Định dạng tiền tệ
        formatCurrency: function(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
    };
    
    appProductEdit.init();

</script>