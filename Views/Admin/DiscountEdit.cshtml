
@{
    Layout = "_LayoutAdmin";
}

<div class="page-content">
  <!-- Start Container Fluid -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-xl-12">
        <div class="card">
          <div
            class="card-header d-flex justify-content-between align-items-center gap-1"
          >
            <h4 class="card-title flex-grow-1">Chỉnh Sửa Phiếu Giảm Giá</h4>

            <a asp-action="Discount" asp-controller="Admin" class="btn btn-sm btn-outline-secondary">
              <i class="bx bx-arrow-back me-1"></i>Quay Lại
            </a>
          </div>
          <div class="card-body">
            <form id="discount-form">
              <input type="hidden" id="id" name="id">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="code" class="form-label">Mã Code <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="code" name="code" placeholder="Nhập mã code (VD: SUMMER2023)" required>
                    <div class="invalid-feedback" id="code-feedback"></div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="description" class="form-label">Mô Tả</label>
                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Mô tả về phiếu giảm giá"></textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label for="type" class="form-label">Loại Giảm Giá <span class="text-danger">*</span></label>
                    <select class="form-select" id="type" name="type" required>
                      <option value="0">Phần trăm (%)</option>
                      <option value="1">Số tiền cố định (VNĐ)</option>
                      <option value="2">Miễn phí vận chuyển</option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label for="discountAmount" class="form-label">Giá Trị Giảm Giá <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="discountAmount" name="discountAmount" min="0" placeholder="Nhập giá trị giảm giá" required>
                    <small id="discountAmountHelp" class="form-text text-muted">
                      Nếu loại giảm giá là phần trăm, giá trị này sẽ là % (ví dụ: 10 = 10%)
                    </small>
                  </div>
                  
                  <div class="mb-3" id="maximumDiscountAmountGroup">
                    <label for="maximumDiscountAmount" class="form-label">Giá Trị Giảm Tối Đa</label>
                    <input type="number" class="form-control" id="maximumDiscountAmount" name="maximumDiscountAmount" min="0" placeholder="Nhập giá trị giảm tối đa (VNĐ)">
                    <small class="form-text text-muted">
                      Áp dụng cho loại giảm giá theo phần trăm để giới hạn số tiền tối đa được giảm
                    </small>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="minimumOrderAmount" class="form-label">Giá Trị Đơn Hàng Tối Thiểu</label>
                    <input type="number" class="form-control" id="minimumOrderAmount" name="minimumOrderAmount" min="0" placeholder="Nhập giá trị đơn hàng tối thiểu (VNĐ)">
                  </div>
                  
                  <div class="mb-3">
                    <label for="remainingQuantity" class="form-label">Số Lượng <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="remainingQuantity" name="remainingQuantity" min="0" placeholder="Nhập số lượng phiếu giảm giá" required>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Thời Gian <span class="text-danger">*</span></label>
                    <div class="row">
                      <div class="col-6">
                        <label for="startDate" class="form-label">Ngày Bắt Đầu</label>
                        <input type="date" class="form-control" id="startDate" name="startDate" required>
                      </div>
                      <div class="col-6">
                        <label for="endDate" class="form-label">Ngày Kết Thúc</label>
                        <input type="date" class="form-control" id="endDate" name="endDate" required>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="storeId" class="form-label">Áp Dụng Cho Cửa Hàng</label>
                    <select class="form-select" id="storeId" name="storeId">
                      <option value="">Toàn hệ thống</option>
                      <!-- JavaScript sẽ tải danh sách cửa hàng -->
                    </select>
                    <small class="form-text text-muted">
                      Nếu không chọn, phiếu giảm giá sẽ áp dụng cho tất cả cửa hàng
                    </small>
                  </div>
                  
                  <div class="mb-3">
                    <label for="status" class="form-label">Trạng Thái</label>
                    <select class="form-select" id="status" name="status">
                      <option value="0">Đang hoạt động</option>
                      <option value="1">Không hoạt động</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-12 text-end">
                  <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='/Admin/Discount'">Hủy</button>
                  <button type="submit" class="btn btn-primary">Cập Nhật Phiếu Giảm Giá</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- End Container Fluid -->

  <!-- ========== Footer Start ========== -->
  <footer class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12 text-center">
          &copy; Hệ Thống Quản Lý Nông Sản VNFarm. All rights reserved.
        </div>
      </div>
    </div>
  </footer>
  <!-- ========== Footer End ========== -->
</div>

<script type="module">
  import { BaseService } from "/custom/BaseService.js";
  import key from "/Custom/jwt.js";
  import url from "/Custom/endpoints.js";

  const jwt = key;
  const discountUrl = url.base + "/Discount";
  const discountService = new BaseService(discountUrl, jwt);
  const storeUrl = url.base + "/Store";
  const storeService = new BaseService(storeUrl, jwt);

  // Lấy ID từ URL
  const params = new URLSearchParams(window.location.search);
  const discountId = params.get('id');
  
  if (!discountId) {
    alert('Không tìm thấy ID phiếu giảm giá');
    window.location.href = '/Admin/Discount';
  }

  // Tải thông tin phiếu giảm giá
  async function loadDiscountInfo() {
    try {
      const response = await discountService.getById(discountId);
      
      if (response && response.success) {
        const discount = response.data;
        
        // Điền thông tin vào form
        document.getElementById('id').value = discount.id;
        document.getElementById('code').value = discount.code;
        document.getElementById('description').value = discount.description;
        document.getElementById('type').value = discount.type;
        document.getElementById('discountAmount').value = discount.discountAmount;
        document.getElementById('maximumDiscountAmount').value = discount.maximumDiscountAmount;
        document.getElementById('minimumOrderAmount').value = discount.minimumOrderAmount;
        document.getElementById('remainingQuantity').value = discount.remainingQuantity;
        
        // Xử lý ngày tháng
        if (discount.startDate) {
          const startDate = new Date(discount.startDate);
          document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }
        
        if (discount.endDate) {
          const endDate = new Date(discount.endDate);
          document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }
        
        // Nếu có storeId, chọn cửa hàng tương ứng
        if (discount.storeId) {
          document.getElementById('storeId').value = discount.storeId;
        }
        
        document.getElementById('status').value = discount.status;
        
        // Cập nhật giao diện theo loại giảm giá
        document.getElementById('type').dispatchEvent(new Event('change'));
      } else {
        alert('Không thể tải thông tin phiếu giảm giá: ' + (response.message || 'Không rõ lỗi'));
        window.location.href = '/Admin/Discount';
      }
    } catch (error) {
      console.error('Error loading discount info:', error);
      alert('Đã xảy ra lỗi khi tải thông tin phiếu giảm giá. Vui lòng thử lại sau.');
      window.location.href = '/Admin/Discount';
    }
  }

  // Tải danh sách cửa hàng
  async function loadStores() {
    try {
      const response = await storeService.getAll();
      
      if (response && response.success) {
        const stores = response.data || [];
        const storeDropdown = document.getElementById('storeId');
        
        stores.forEach(store => {
          const option = document.createElement('option');
          option.value = store.id;
          option.textContent = store.name;
          storeDropdown.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading stores:', error);
    }
  }
  
  // Xử lý sự kiện thay đổi loại giảm giá
  document.getElementById('type').addEventListener('change', function() {
    const type = parseInt(this.value);
    const maximumDiscountAmountGroup = document.getElementById('maximumDiscountAmountGroup');
    const discountAmountHelp = document.getElementById('discountAmountHelp');
    
    if (type === 0) { // Phần trăm
      maximumDiscountAmountGroup.style.display = 'block';
      discountAmountHelp.textContent = 'Giá trị này sẽ là % (ví dụ: 10 = 10%)';
      
      // Giới hạn giá trị tối đa là 100%
      document.getElementById('discountAmount').setAttribute('max', '100');
    } else if (type === 1) { // Số tiền cố định
      maximumDiscountAmountGroup.style.display = 'none';
      discountAmountHelp.textContent = 'Giá trị này sẽ là số tiền cố định (VNĐ)';
      
      // Xóa giới hạn giá trị tối đa
      document.getElementById('discountAmount').removeAttribute('max');
    } else { // Miễn phí vận chuyển
      maximumDiscountAmountGroup.style.display = 'none';
      discountAmountHelp.textContent = 'Nếu chọn miễn phí vận chuyển, giá trị này sẽ là số tiền tối đa được miễn';
      
      // Xóa giới hạn giá trị tối đa
      document.getElementById('discountAmount').removeAttribute('max');
    }
  });
  
  // Xử lý form submit
  document.getElementById('discount-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Lấy dữ liệu từ form
    const formData = {
      id: parseInt(document.getElementById('id').value),
      code: document.getElementById('code').value,
      description: document.getElementById('description').value,
      type: parseInt(document.getElementById('type').value),
      discountAmount: parseFloat(document.getElementById('discountAmount').value),
      maximumDiscountAmount: document.getElementById('maximumDiscountAmount').value ? parseFloat(document.getElementById('maximumDiscountAmount').value) : 0,
      minimumOrderAmount: document.getElementById('minimumOrderAmount').value ? parseFloat(document.getElementById('minimumOrderAmount').value) : 0,
      remainingQuantity: parseInt(document.getElementById('remainingQuantity').value),
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      storeId: document.getElementById('storeId').value ? parseInt(document.getElementById('storeId').value) : null,
      status: parseInt(document.getElementById('status').value)
    };
    
    // Kiểm tra ngày kết thúc phải sau ngày bắt đầu
    const startDate = new Date(formData.startDate);
    const endDate = new Date(formData.endDate);
    
    if (endDate <= startDate) {
      alert('Ngày kết thúc phải sau ngày bắt đầu');
      return;
    }
    
    // Kiểm tra mã code
    if (formData.code.trim() === '') {
      document.getElementById('code-feedback').textContent = 'Vui lòng nhập mã code';
      document.getElementById('code').classList.add('is-invalid');
      return;
    }
    
    // Kiểm tra mã code có trùng không (ngoại trừ chính nó)
    discountService
      .find({ searchTerm: formData.code })
      .then((response) => {
        if (response && response.success && response.data && response.data.length > 0) {
          // Nếu tìm thấy kết quả có mã trùng và không phải là chính nó
          const duplicates = response.data.filter(d => 
            d.code.toLowerCase() === formData.code.toLowerCase() && 
            d.id !== formData.id
          );
          
          if (duplicates.length > 0) {
            document.getElementById('code-feedback').textContent = 'Mã code này đã tồn tại, vui lòng chọn mã khác';
            document.getElementById('code').classList.add('is-invalid');
            return;
          }
        }
        
        // Nếu không trùng, tiến hành cập nhật
        updateDiscount(formData);
      })
      .catch((error) => {
        console.error('Error checking code:', error);
        alert('Đã xảy ra lỗi khi kiểm tra mã code. Vui lòng thử lại sau.');
      });
  });
  
  // Cập nhật phiếu giảm giá
  function updateDiscount(data) {
    discountService
      .update(data)
      .then((response) => {
        if (response && response.success) {
          alert('Cập nhật phiếu giảm giá thành công!');
          window.location.href = '/Admin/Discount';
        } else {
          alert('Cập nhật phiếu giảm giá thất bại: ' + (response.message || 'Không rõ lỗi'));
        }
      })
      .catch((error) => {
        console.error('Error updating discount:', error);
        alert('Đã xảy ra lỗi khi cập nhật phiếu giảm giá. Vui lòng thử lại sau.');
      });
  }
  
  // Xóa thông báo lỗi khi người dùng nhập lại
  document.getElementById('code').addEventListener('input', function() {
    this.classList.remove('is-invalid');
    document.getElementById('code-feedback').textContent = '';
  });
  
  // Khởi tạo
  async function init() {
    try {
      await loadStores();
      await loadDiscountInfo();
    } catch (error) {
      console.error('Initialization error:', error);
    }
  }
  
  init();
</script> 