@{
    Layout = "_LayoutAdmin";
}

<div class="page-content">

    <!-- Loading indicator -->
    <div id="loading-indicator" class="container-xxl d-none">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6 text-center">
                <div class="card border-0 shadow-none">
                    <div class="card-body">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h4 class="fw-medium">Đang xử lý...</h4>
                        <p class="text-muted">Vui lòng đợi trong giây lát</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="container-xxl d-none">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6">
                <div class="card border-0 shadow">
                    <div class="card-body text-center p-5">
                        <div class="mb-4">
                            <i class="bx bx-check-circle text-success display-1"></i>
                        </div>
                        <h3>Thêm sản phẩm thành công!</h3>
                        <p class="text-muted">Sản phẩm của bạn đã được thêm vào hệ thống</p>
                        <div class="mt-4">
                            <button class="btn btn-primary me-2" id="view-product-btn">Xem sản phẩm</button>
                            <button class="btn btn-outline-primary" id="add-another-btn">Thêm sản phẩm khác</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="container-xxl d-none">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6">
                <div class="card border-0 shadow">
                    <div class="card-body text-center p-5">
                        <div class="mb-4">
                            <i class="bx bx-error-circle text-danger display-1"></i>
                        </div>
                        <h3>Đã xảy ra lỗi!</h3>
                        <p id="error-text" class="text-muted">Không thể thêm sản phẩm, vui lòng thử lại sau.</p>
                        <div class="mt-4">
                            <button class="btn btn-primary" id="try-again-btn">Thử lại</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form Container -->
    <div id="form-container" class="container-xxl">
        <div class="row">
            <div class="col-12">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <h4 class="card-title mb-0">Thêm Ảnh Sản Phẩm</h4>
                                <div>
                                    <span class="badge bg-danger-subtle text-danger" id="image-error" style="display: none;">Vui lòng tải lên ảnh sản phẩm</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- File Upload -->
                                <form action="#" class="dropzone" id="productImageUpload">
                                    <div class="fallback">
                                        <input name="file" type="file" accept="image/*" />
                                    </div>
                                    <div class="dz-message needsclick">
                                        <i class="bx bx-cloud-upload fs-48 text-primary"></i>
                                        <h3 class="mt-4">Kéo thả ảnh vào đây, hoặc <span class="text-primary">click để chọn</span></h3>
                                        <span class="text-muted fs-13">
                                            1600 x 1200 (4:3) được khuyến nghị. Chấp nhận file PNG, JPG và GIF
                                        </span>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Thông Tin Sản Phẩm</h4>
                    </div>
                    <div class="card-body">
                        <form id="productForm">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-name" class="form-label">Tên Sản Phẩm <span class="text-danger">*</span></label>
                                        <input type="text" id="product-name" name="name" class="form-control" placeholder="Nhập tên sản phẩm" required>
                                        <div class="invalid-feedback">Vui lòng nhập tên sản phẩm</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-category" class="form-label">Danh Mục Sản Phẩm <span class="text-danger">*</span></label>
                                        <select class="form-select" id="product-category" name="categoryId" required>
                                            <option value="" disabled selected>Chọn danh mục</option>
                                            <!-- Danh mục sẽ được load từ API -->
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn danh mục sản phẩm</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-origin" class="form-label">Xuất Xứ <span class="text-danger">*</span></label>
                                        <select class="form-select" id="product-origin" name="origin" required>
                                            <option value="" disabled selected>Chọn xuất xứ</option>
                                            <!-- Xuất xứ sẽ được load từ API -->
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn xuất xứ sản phẩm</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-unit" class="form-label">Đơn Vị <span class="text-danger">*</span></label>
                                        <select class="form-select" id="product-unit" name="unit" required>
                                            <option value="" disabled selected>Chọn đơn vị</option>
                                            <!-- Đơn vị sẽ được load từ API -->
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn đơn vị sản phẩm</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label for="product-description" class="form-label">Mô Tả</label>
                                        <textarea class="form-control" id="product-description" name="description" rows="5" placeholder="Mô tả chi tiết về sản phẩm"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-price" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                                        <input type="number" id="product-price" name="price" class="form-control" placeholder="Nhập giá sản phẩm" min="0" required>
                                        <div class="invalid-feedback">Vui lòng nhập giá sản phẩm hợp lệ</div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="product-stock" class="form-label">Số Lượng Tồn Kho <span class="text-danger">*</span></label>
                                        <input type="number" id="product-stock" name="stockQuantity" class="form-control" placeholder="Nhập số lượng" min="0" required>
                                        <div class="invalid-feedback">Vui lòng nhập số lượng tồn kho hợp lệ</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="product-active" name="isActive" checked>
                                        <label class="form-check-label" for="product-active">Kích hoạt sản phẩm (sản phẩm sẽ hiển thị ngay sau khi tạo)</label>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="product-store-id" name="storeId" value="5">
                            <input type="hidden" id="product-image-url" name="imageUrl" value="">
                            <input type="hidden" id="product-image-file" name="imageFile" value="">
                        </form>
                    </div>
                </div>
                <div class="p-3 bg-light mb-3 rounded">
                    <div class="row justify-content-end g-2">
                        <div class="col-lg-2">
                            <button type="button" class="btn btn-outline-secondary w-100" id="reset-button">Làm Mới</button>
                        </div>
                        <div class="col-lg-2">
                            <button type="button" class="btn btn-primary w-100" id="submit-button">Thêm Sản Phẩm</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Container Fluid -->

    <!-- ========== Footer Start ========== -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 text-center">
                    &copy; VNFarm. Crafted by <iconify-icon icon="iconamoon:heart-duotone" class="fs-18 align-middle text-danger"></iconify-icon> <a href="#" class="fw-bold footer-text" target="_blank">Hệ Thống Quản Lý Nông Sản VNFarm</a>
                </div>
            </div>
        </div>
    </footer>
    <!-- ========== Footer End ========== -->

</div>

<script type="module">
    import { BaseService } from "/custom/BaseService.js";
    import { EnumService } from "/custom/EnumService.js";
    import key from "/custom/jwt.js";
    import url from "/Custom/endpoints.js";
    

    const appProductAdd = {
        categoryData: [],
        unitTypes: {},
        originTypes: [],
        dropzone: null,
        uploadedImage: null,
        createdProductId: null,
        storeId: 5, 
        
        init: function() {
            const jwt = key;
            const productUrl = url.base + "/Product";
            const categoryUrl = url.base + "/Category";
            this.productService = new BaseService(productUrl, jwt);
            this.categoryService = new BaseService(categoryUrl, jwt);
            this.enumService = new EnumService(url.baseUrl, jwt);
            
            // Vô hiệu hóa autoDiscover
            Dropzone.autoDiscover = false;
            
            // Khởi tạo Dropzone để upload ảnh
            this.initDropzone();
            
            // Tải dữ liệu danh mục, đơn vị, xuất xứ
            this.loadCategories();
            this.loadUnitTypes();
            this.loadOriginTypes();
            
            // Thiết lập các sự kiện cho form
            this.setupEventListeners();
        },
        
        // Hiển thị/ẩn trạng thái loading
        toggleLoading: function(isLoading) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const formContainer = document.getElementById('form-container');
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');
            
            if (isLoading) {
                loadingIndicator.classList.remove('d-none');
                formContainer.classList.add('d-none');
                successMessage.classList.add('d-none');
                errorMessage.classList.add('d-none');
            } else {
                loadingIndicator.classList.add('d-none');
            }
        },
        
        // Hiển thị thông báo thành công
        showSuccess: function(productId) {
            this.createdProductId = productId;
            const formContainer = document.getElementById('form-container');
            const successMessage = document.getElementById('success-message');
            
            formContainer.classList.add('d-none');
            successMessage.classList.remove('d-none');
        },
        
        // Hiển thị thông báo lỗi
        showError: function(message) {
            const formContainer = document.getElementById('form-container');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            errorText.textContent = message || "Không thể thêm sản phẩm, vui lòng thử lại sau.";
            formContainer.classList.add('d-none');
            errorMessage.classList.remove('d-none');
        },
        
        // Thiết lập Dropzone để upload ảnh
        initDropzone: function() {
            const self = this;
            
            this.dropzone = new Dropzone("#productImageUpload", {
                url: "/#", // URL giả để không tự động upload
                autoProcessQueue: false,
                maxFiles: 1,
                acceptedFiles: "image/*",
                addRemoveLinks: true,
                dictRemoveFile: "Xóa",
                dictDefaultMessage: "Kéo thả ảnh vào đây hoặc click để chọn",
                init: function() {
                    this.on("addedfile", function(file) {
                        // Nếu đã có file, xóa file cũ
                        if (this.files.length > 1) {
                            this.removeFile(this.files[0]);
                        }
                        
                        // Lưu file để sử dụng sau
                        self.uploadedImage = file;
                        
                        // Ẩn thông báo lỗi nếu có
                        document.getElementById('image-error').style.display = 'none';
                    });
                    
                    this.on("removedfile", function() {
                        self.uploadedImage = null;
                    });
                }
            });
        },
        
        // Tải danh sách danh mục
        loadCategories: function() {
            const self = this;
            const categorySelect = document.getElementById('product-category');
            
            this.categoryService.getAll()
                .then(function(response) {
                    if (response && response.success && response.data) {
                        self.categoryData = response.data;
                        
                        // Thêm các option vào select
                        response.data.forEach(function(category) {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        });
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi tải danh mục:", error);
                });
        },
        
        // Tải danh sách đơn vị
        loadUnitTypes: function() {
            const self = this;
            const unitSelect = document.getElementById('product-unit');
            
            this.enumService.getUnitTypes()
                .then(function(data) {
                    if (data) {
                        self.unitTypes = data;
                        
                        // Thêm các option vào select
                        Object.keys(data).forEach(function(key) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = data[key];
                            unitSelect.appendChild(option);
                        });
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi tải đơn vị:", error);
                });
        },
        
        // Tải danh sách xuất xứ
        loadOriginTypes: function() {
            const self = this;
            const originSelect = document.getElementById('product-origin');
            
            this.enumService.getOriginTypes()
                .then(function(data) {
                    if (data) {
                        self.originTypes = data;
                        
                        // Thêm các option vào select
                        data.forEach(function(origin) {
                            const option = document.createElement('option');
                            option.value = origin;
                            option.textContent = origin;
                            originSelect.appendChild(option);
                        });
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi tải xuất xứ:", error);
                });
        },
        
        // Thiết lập các sự kiện
        setupEventListeners: function() {
            const self = this;
            
            // Nút thêm sản phẩm
            document.getElementById('submit-button').addEventListener('click', function() {
                self.submitForm();
            });
            
            // Nút làm mới
            document.getElementById('reset-button').addEventListener('click', function() {
                self.resetForm();
            });
            
            // Nút thử lại khi có lỗi
            document.getElementById('try-again-btn').addEventListener('click', function() {
                const formContainer = document.getElementById('form-container');
                const errorMessage = document.getElementById('error-message');
                
                errorMessage.classList.add('d-none');
                formContainer.classList.remove('d-none');
            });
            
            // Nút xem sản phẩm sau khi thêm thành công
            document.getElementById('view-product-btn').addEventListener('click', function() {
                if (self.createdProductId) {
                    window.location.href = `00_layout.html?file=00_product_details.html&id=${self.createdProductId}`;
                }
            });
            
            // Nút thêm sản phẩm khác
            document.getElementById('add-another-btn').addEventListener('click', function() {
                const formContainer = document.getElementById('form-container');
                const successMessage = document.getElementById('success-message');
                
                successMessage.classList.add('d-none');
                formContainer.classList.remove('d-none');
                self.resetForm();
            });
        },
        
        // Validate form trước khi submit
        validateForm: function() {
            const form = document.getElementById('productForm');
            
            // Thêm class was-validated để hiển thị validation
            form.classList.add('was-validated');
            
            // Kiểm tra các trường bắt buộc
            const name = document.getElementById('product-name').value;
            const categoryId = document.getElementById('product-category').value;
            const origin = document.getElementById('product-origin').value;
            const unit = document.getElementById('product-unit').value;
            const price = document.getElementById('product-price').value;
            const stockQuantity = document.getElementById('product-stock').value;
            
            // Kiểm tra ảnh
            if (!this.uploadedImage) {
                document.getElementById('image-error').style.display = 'inline-block';
                return false;
            }
            
            // Kiểm tra các trường khác
            if (!name || !categoryId || !origin || !unit || !price || !stockQuantity) {
                return false;
            }
            
            return true;
        },
        
        // Submit form
        submitForm: function() {
            if (!this.validateForm()) {
                return;
            }
            
            const self = this;
            
            // Tạo FormData để có thể gửi file
            const formData = new FormData();
            
            // Thêm các trường vào FormData
            formData.append('name', document.getElementById('product-name').value);
            formData.append('description', document.getElementById('product-description').value || "");
            formData.append('price', document.getElementById('product-price').value);
            formData.append('stockQuantity', document.getElementById('product-stock').value);
            formData.append('unit', document.getElementById('product-unit').value);
            formData.append('storeId', this.storeId);
            formData.append('categoryId', document.getElementById('product-category').value);
            formData.append('origin', document.getElementById('product-origin').value);
            formData.append('isActive', document.getElementById('product-active').checked);
            
            // Thêm file ảnh
            if (this.uploadedImage) {
                formData.append('imageFile', this.uploadedImage);
            }
            
            // Hiển thị loading
            this.toggleLoading(true);
            
            // Sử dụng hàm create với tham số isFormData=true
            this.productService.create(formData, true)
                .then(function(data) {
                    if (data && data.success) {
                        // Hiển thị thông báo thành công
                        self.showSuccess(data.data.id);
                    } else {
                        // Hiển thị thông báo lỗi
                        self.showError(data.message || "Không thể thêm sản phẩm");
                    }
                })
                .catch(function(error) {
                    console.error("Lỗi khi thêm sản phẩm:", error);
                    self.showError(error.message || "Đã xảy ra lỗi khi thêm sản phẩm");
                })
                .finally(function() {
                    // Ẩn loading
                    self.toggleLoading(false);
                });
        },
        
        // Reset form
        resetForm: function() {
            const form = document.getElementById('productForm');
            form.reset();
            form.classList.remove('was-validated');
            
            // Reset dropzone
            this.dropzone.removeAllFiles();
            this.uploadedImage = null;
            
            // Ẩn thông báo lỗi
            document.getElementById('image-error').style.display = 'none';
        }
    };
    appProductAdd.init();
</script>