@{
    Layout = "_LayoutAdmin";
}

<div class="page-content">
  <!-- Start Container Fluid -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-xl-12">
        <div class="card">
          <div
            class="card-header d-flex justify-content-between align-items-center gap-1"
          >
            <h4 class="card-title flex-grow-1">Thêm Phiếu Giảm Giá Mới</h4>

            <a asp-action="Discount" asp-controller="Admin" class="btn btn-sm btn-outline-secondary">
              <i class="bx bx-arrow-back me-1"></i>Quay Lại
            </a>
          </div>
          <div class="card-body">
            <form id="discount-form">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="code" class="form-label">Mã Code <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="code" name="code" placeholder="Nhập mã code (VD: SUMMER2023)" required>
                    <div class="invalid-feedback" id="code-feedback"></div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="description" class="form-label">Mô Tả</label>
                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Mô tả về phiếu giảm giá"></textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label for="type" class="form-label">Loại Giảm Giá <span class="text-danger">*</span></label>
                    <select class="form-select" id="type" name="type" required>
                      <option value="0">Phần trăm (%)</option>
                      <option value="1">Số tiền cố định (VNĐ)</option>
                      <option value="2">Miễn phí vận chuyển</option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label for="discountAmount" class="form-label">Giá Trị Giảm Giá <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="discountAmount" name="discountAmount" min="0" placeholder="Nhập giá trị giảm giá" required>
                    <small id="discountAmountHelp" class="form-text text-muted">
                      Nếu loại giảm giá là phần trăm, giá trị này sẽ là % (ví dụ: 10 = 10%)
                    </small>
                  </div>
                  
                  <div class="mb-3" id="maximumDiscountAmountGroup">
                    <label for="maximumDiscountAmount" class="form-label">Giá Trị Giảm Tối Đa</label>
                    <input type="number" class="form-control" id="maximumDiscountAmount" name="maximumDiscountAmount" min="0" placeholder="Nhập giá trị giảm tối đa (VNĐ)">
                    <small class="form-text text-muted">
                      Áp dụng cho loại giảm giá theo phần trăm để giới hạn số tiền tối đa được giảm
                    </small>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="minimumOrderAmount" class="form-label">Giá Trị Đơn Hàng Tối Thiểu</label>
                    <input type="number" class="form-control" id="minimumOrderAmount" name="minimumOrderAmount" min="0" placeholder="Nhập giá trị đơn hàng tối thiểu (VNĐ)">
                  </div>
                  
                  <div class="mb-3">
                    <label for="remainingQuantity" class="form-label">Số Lượng <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="remainingQuantity" name="remainingQuantity" min="1" placeholder="Nhập số lượng phiếu giảm giá" required>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Thời Gian <span class="text-danger">*</span></label>
                    <div class="row">
                      <div class="col-6">
                        <label for="startDate" class="form-label">Ngày Bắt Đầu</label>
                        <input type="date" class="form-control" id="startDate" name="startDate" required>
                      </div>
                      <div class="col-6">
                        <label for="endDate" class="form-label">Ngày Kết Thúc</label>
                        <input type="date" class="form-control" id="endDate" name="endDate" required>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="storeId" class="form-label">Áp Dụng Cho Cửa Hàng</label>
                    <select class="form-select" id="storeId" name="storeId">
                      <option value="">Toàn hệ thống</option>
                      <!-- JavaScript sẽ tải danh sách cửa hàng -->
                    </select>
                    <small class="form-text text-muted">
                      Nếu không chọn, phiếu giảm giá sẽ áp dụng cho tất cả cửa hàng
                    </small>
                  </div>
                  
                  <div class="mb-3">
                    <label for="status" class="form-label">Trạng Thái</label>
                    <select class="form-select" id="status" name="status">
                      <option value="0">Đang hoạt động</option>
                      <option value="1">Không hoạt động</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-12 text-end">
                  <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='/Admin/Discount'">Hủy</button>
                  <button type="submit" class="btn btn-primary">Lưu Phiếu Giảm Giá</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- End Container Fluid -->

  <!-- ========== Footer Start ========== -->
  <footer class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12 text-center">
          &copy; Hệ Thống Quản Lý Nông Sản VNFarm. All rights reserved.
        </div>
      </div>
    </div>
  </footer>
  <!-- ========== Footer End ========== -->
</div>

<script type="module">
  import { BaseService } from "/custom/BaseService.js";
  import key from "/Custom/jwt.js";
  import url from "/Custom/endpoints.js";
  import Toast from "/Custom/Toast_Seller.js";

  const jwt = key;
  const discountUrl = url.base + "/Discount";
  const discountService = new BaseService(discountUrl, jwt);
  const storeUrl = url.base + "/Store";
  const storeService = new BaseService(storeUrl, jwt);

  // Đặt ngày mặc định
  const today = new Date();
  document.getElementById('startDate').valueAsDate = today;
  
  const nextMonth = new Date();
  nextMonth.setMonth(nextMonth.getMonth() + 1);
  document.getElementById('endDate').valueAsDate = nextMonth;

  // Tải danh sách cửa hàng
  function loadStores() {
    const storeDropdown = document.getElementById("storeId");
    
    storeService
      .getAll()
      .then((data) => {
        if (data && data.success) {
          const items = data.data || [];
          
          items.forEach((item) => {
            const option = document.createElement("option");
            option.value = item.id;
            option.textContent = item.name;
            storeDropdown.appendChild(option);
          });
        }
      })
      .catch((error) => {
        console.error("Error retrieving stores:", error);
      });
  }
  
  // Xử lý sự kiện thay đổi loại giảm giá
  document.getElementById('type').addEventListener('change', function() {
    const type = parseInt(this.value);
    const maximumDiscountAmountGroup = document.getElementById('maximumDiscountAmountGroup');
    const discountAmountHelp = document.getElementById('discountAmountHelp');
    
    if (type === 0) { // Phần trăm
      maximumDiscountAmountGroup.style.display = 'block';
      discountAmountHelp.textContent = 'Giá trị này sẽ là % (ví dụ: 10 = 10%)';
      
      // Giới hạn giá trị tối đa là 100%
      document.getElementById('discountAmount').setAttribute('max', '100');
    } else if (type === 1) { // Số tiền cố định
      maximumDiscountAmountGroup.style.display = 'none';
      discountAmountHelp.textContent = 'Giá trị này sẽ là số tiền cố định (VNĐ)';
      
      // Xóa giới hạn giá trị tối đa
      document.getElementById('discountAmount').removeAttribute('max');
    } else { // Miễn phí vận chuyển
      maximumDiscountAmountGroup.style.display = 'none';
      discountAmountHelp.textContent = 'Nếu chọn miễn phí vận chuyển, giá trị này sẽ là số tiền tối đa được miễn';
      
      // Xóa giới hạn giá trị tối đa
      document.getElementById('discountAmount').removeAttribute('max');
    }
  });
  
  // Xử lý form submit
  document.getElementById('discount-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Lấy dữ liệu từ form
    const formData = new FormData();
    formData.append('code', document.getElementById('code').value);
    formData.append('description', document.getElementById('description').value);
    formData.append('type', document.getElementById('type').value);
    formData.append('discountAmount', document.getElementById('discountAmount').value);
    formData.append('maximumDiscountAmount', document.getElementById('maximumDiscountAmount').value || '0');
    formData.append('minimumOrderAmount', document.getElementById('minimumOrderAmount').value || '0');
    formData.append('remainingQuantity', document.getElementById('remainingQuantity').value);
    formData.append('startDate', document.getElementById('startDate').value);
    formData.append('endDate', document.getElementById('endDate').value);
    formData.append('storeId', document.getElementById('storeId').value || '');
    formData.append('status', document.getElementById('status').value);
    
    // Kiểm tra ngày kết thúc phải sau ngày bắt đầu
    const startDate = new Date(formData.startDate);
    const endDate = new Date(formData.endDate);
    
    if (endDate <= startDate) {
      Toast.error('Ngày kết thúc phải sau ngày bắt đầu');
      return;
    }
    
    // Kiểm tra mã code
    if (document.getElementById('code').value.trim() === '') {
      document.getElementById('code-feedback').textContent = 'Vui lòng nhập mã code';
      document.getElementById('code').classList.add('is-invalid');
      return;
    }
    
    // Kiểm tra mã code có trùng không
    discountService
      .find({ searchTerm: formData.code })
      .then((response) => {
        if (response && response.success && response.data && response.data.length > 0) {
          // Nếu tìm thấy kết quả có mã trùng
          if (response.data.some(d => d.code === document.getElementById('code').value)) {
            Toast.error('Mã code này đã tồn tại, vui lòng chọn mã khác');
            document.getElementById('code-feedback').textContent = 'Mã code này đã tồn tại, vui lòng chọn mã khác';
            document.getElementById('code').classList.add('is-invalid');
            return;
          }
        }
        
        // Nếu không trùng, tiến hành lưu
        saveDiscount(formData);
      })
      .catch((error) => {
        console.error('Error checking code:', error);
        Toast.error('Đã xảy ra lỗi khi kiểm tra mã code. Vui lòng thử lại sau.');
      });
  });
  
  // Lưu phiếu giảm giá
  function saveDiscount(data) {
    discountService
      .create(data, true)
      .then((response) => {
        if (response && response.success) {
          Toast.success('Thêm phiếu giảm giá thành công!');
          setTimeout(() => {
            window.location.href = '/Admin/Discount';
          }, 2000);
        } else {
          Toast.error('Thêm phiếu giảm giá thất bại: ' + (response.message || 'Không rõ lỗi'));
        }
      })
      .catch((error) => {
        console.error('Error saving discount:', error);
        Toast.error('Đã xảy ra lỗi khi lưu phiếu giảm giá. Vui lòng thử lại sau.');
      });
  }
  
  // Xóa thông báo lỗi khi người dùng nhập lại
  document.getElementById('code').addEventListener('input', function() {
    this.classList.remove('is-invalid');
    document.getElementById('code-feedback').textContent = '';
  });
  
  // Khởi tạo
  loadStores();
  // Kích hoạt sự kiện change để cập nhật giao diện theo loại giảm giá mặc định
  document.getElementById('type').dispatchEvent(new Event('change'));
</script> 