@{
    Layout = "_LayoutAdmin";
}

<div class="page-content">
  <!-- Loading indicator -->
  <div id="loading-indicator" class="container-xxl">
    <div class="row justify-content-center mt-5">
      <div class="col-md-8 col-lg-6 text-center">
        <div class="card border-0 shadow-none">
          <div class="card-body">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="fw-medium">Đang tải thông tin sản phẩm...</h4>
            <p class="text-muted">Vui lòng đợi trong giây lát</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Container Fluid -->
  <div id="product-content" class="container-xxl d-none">
    <div class="row">
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <!-- Crossfade -->
            <div
              id="carouselExampleFade"
              class="carousel slide carousel-fade"
              data-bs-ride="carousel"
            >
              <div class="carousel-inner" role="listbox">
                <div class="carousel-item active">
                  <img
                    src="assets/images/product/p-1.png"
                    alt=""
                    class="img-fluid bg-light rounded"
                  />
                </div>
                <div class="carousel-item">
                  <img
                    src="assets/images/product/p-10.png"
                    alt=""
                    class="img-fluid bg-light rounded"
                  />
                </div>
                <div class="carousel-item">
                  <img
                    src="assets/images/product/p-13.png"
                    alt=""
                    class="img-fluid bg-light rounded"
                  />
                </div>
                <div class="carousel-item">
                  <img
                    src="assets/images/product/p-14.png"
                    alt=""
                    class="img-fluid bg-light rounded"
                  />
                </div>
              </div>
              <div
                class="carousel-indicators m-0 mt-2 d-lg-flex d-none position-static h-100"
              >
                <button
                  type="button"
                  data-bs-target="#carouselExampleFade"
                  data-bs-slide-to="0"
                  aria-current="true"
                  aria-label="Slide 1"
                  class="w-auto h-auto rounded bg-light active"
                >
                  <img
                    src="assets/images/product/p-1.png"
                    class="d-block avatar-xl"
                    alt="swiper-indicator-img"
                  />
                </button>
                <button
                  type="button"
                  data-bs-target="#carouselExampleFade"
                  data-bs-slide-to="1"
                  aria-label="Slide 2"
                  class="w-auto h-auto rounded bg-light"
                >
                  <img
                    src="assets/images/product/p-10.png"
                    class="d-block avatar-xl"
                    alt="swiper-indicator-img"
                  />
                </button>
                <button
                  type="button"
                  data-bs-target="#carouselExampleFade"
                  data-bs-slide-to="2"
                  aria-label="Slide 3"
                  class="w-auto h-auto rounded bg-light"
                >
                  <img
                    src="assets/images/product/p-13.png"
                    class="d-block avatar-xl"
                    alt="swiper-indicator-img"
                  />
                </button>
                <button
                  type="button"
                  data-bs-target="#carouselExampleFade"
                  data-bs-slide-to="3"
                  aria-label="Slide 3"
                  class="w-auto h-auto rounded bg-light"
                >
                  <img
                    src="assets/images/product/p-14.png"
                    class="d-block avatar-xl"
                    alt="swiper-indicator-img"
                  />
                </button>
              </div>
            </div>
          </div>
          <div class="card-footer border-top">
            <div class="row g-2">
              <div class="col-lg-12">
                <a
                  href="#!"
                  class="btn btn-primary d-flex align-items-center justify-content-center gap-2 w-100"
                  ><i class="bx bx-edit fs-18"></i> Chỉnh sửa</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <h4 class="badge bg-success text-light fs-14 py-1 px-2">
              Sản Phẩm Mới
            </h4>
            <p class="mb-1">
              <a href="#!" class="fs-24 text-dark fw-medium"
                >Xoài Cát Hòa Lộc</a
              >
            </p>
            <div class="d-flex gap-2 align-items-center">
              <ul class="d-flex text-warning m-0 fs-20 list-unstyled">
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star-half"></i>
                </li>
              </ul>
              <p class="mb-0 fw-medium fs-18 text-dark" id="rating-count">
                
              </p>
            </div>
            <h2 class="fw-medium my-3">
              80.000đ
              <span class="fs-16 text-decoration-line-through">100.000đ</span
              ><small class="text-danger ms-2">(20%Off)</small>
            </h2>

            <div class="row align-items-center g-2 mt-3">
              <div class="col-lg-6">
                <div class="">
                  <h5 class="text-dark fw-medium">
                    Xuất xứ > <span class="text-muted">Tiền Giang</span>
                  </h5>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="">
                  <h5 class="text-dark fw-medium">
                    Đơn vị > <span class="text-muted">kg</span>
                  </h5>
                </div>
              </div>
            </div>
            <div class="quantity mt-4">
              <h4 class="text-dark fw-medium mt-3">Số lượng :</h4>
              <div
                class="input-step border bg-body-secondary p-1 mt-1 rounded d-inline-flex overflow-visible"
              >
                <button
                  type="button"
                  class="minus bg-light text-dark border-0 rounded-1 fs-20 lh-1 h-100"
                >
                  -
                </button>
                <input
                  type="number"
                  class="text-dark text-center border-0 bg-body-secondary rounded h-100"
                  value="1"
                  min="0"
                  max="100"
                  readonly=""
                />
                <button
                  type="button"
                  class="plus bg-light text-dark border-0 rounded-1 fs-20 lh-1 h-100"
                >
                  +
                </button>
              </div>
            </div>
            <ul class="d-flex flex-column gap-2 list-unstyled fs-15 my-3">
              <li><i class="bx bx-check text-success"></i> Còn hàng</li>
              <li>
                <i class="bx bx-check text-success"></i> Miễn phí vận chuyển cho
                đơn hàng trên 500.000đ
              </li>
              <li>
                <i class="bx bx-check text-success"></i> Giảm 20% khi mua từ 5kg
                trở lên
              </li>
            </ul>
            <h4 class="text-dark fw-medium">Mô tả sản phẩm :</h4>
            <p class="text-muted" id="product-description">
              <!-- Auto generate with API -->
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header">
            <h4 class="card-title">Chi Tiết Sản Phẩm</h4>
          </div>
          <div class="card-body">
            <div class="">
              <ul
                class="d-flex flex-column gap-2 list-unstyled fs-14 text-muted mb-0"
              >
                <li>
                  <span class="fw-medium text-dark">Mã sản phẩm</span
                  ><span class="mx-2">:</span>XN001
                </li>
                <li>
                  <span class="fw-medium text-dark">Ngày nhập kho</span
                  ><span class="mx-2">:</span>16/03/2024
                </li>
                <li>
                  <span class="fw-medium text-dark">Danh mục</span
                  ><span class="mx-2">:</span>Trái Cây
                </li>
                <li>
                  <span class="fw-medium text-dark">Nhà cung cấp</span
                  ><span class="mx-2">:</span>Nông Trại Xanh Tiền Giang
                </li>
                <li>
                  <span class="fw-medium text-dark">Vùng trồng</span
                  ><span class="mx-2">:</span>Hòa Lộc, Tiền Giang
                </li>
                <li>
                  <span class="fw-medium text-dark">Phương pháp trồng</span
                  ><span class="mx-2">:</span>Hữu cơ
                </li>
                <li>
                  <span class="fw-medium text-dark">Trọng lượng trung bình</span
                  ><span class="mx-2">:</span>0.8 - 1.2 kg/quả
                </li>
                <li>
                  <span class="fw-medium text-dark">Độ chín</span
                  ><span class="mx-2">:</span>85-90%
                </li>
                <li>
                  <span class="fw-medium text-dark">Chứng nhận</span
                  ><span class="mx-2">:</span>VietGAP
                </li>
                <li>
                  <span class="fw-medium text-dark">Tồn kho</span
                  ><span class="mx-2">:</span>486 kg
                </li>
                <li>
                  <span class="fw-medium text-dark">Đã bán</span
                  ><span class="mx-2">:</span>155 kg
                </li>
              </ul>
            </div>
            @* <div class="mt-3">
              <a
                href="#!"
                class="link-primary text-decoration-underline link-offset-2"
                >Xem thêm chi tiết
                <i class="bx bx-arrow-to-right align-middle fs-16"></i
              ></a>
            </div> *@
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card card-review h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title">Đánh Giá Từ Khách Hàng</h4>
            <a id="review-link" class="link-primary text-decoration-underline">Xem chi tiết đánh giá <i class="bx bx-arrow-to-right align-middle fs-16"></i></a>
          </div>
          <div class="card-body">
            <div class="d-flex align-items-center gap-2">
              <img
                src="assets/images/users/avatar-6.jpg"
                alt=""
                class="avatar-md rounded-circle"
              />
              <div>
                <h5 class="mb-0">Nguyễn Văn A</h5>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2 mt-3 mb-1">
              <ul class="d-flex text-warning m-0 fs-20 list-unstyled">
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star-half"></i>
                </li>
              </ul>
              <p class="fw-medium mb-0 text-dark fs-15">Chất lượng rất tốt</p>
            </div>

            <p class="mb-0 text-dark fw-medium fs-15">
              Đánh giá vào ngày 16/03/2024
            </p>
            <p class="text-muted">
              Xoài ngon, ngọt, thịt dày, hạt nhỏ. Giao hàng nhanh, đóng gói cẩn
              thận. Sẽ ủng hộ tiếp.
            </p>
            <div class="mt-2">
              <a href="#!" class="fs-14 me-3 text-muted"
                ><i class="bx bx-like"></i> Hữu ích</a
              >
              <a href="#!" class="fs-14 text-muted">Báo cáo</a>
            </div>

            <hr class="my-3" />

            <div class="d-flex align-items-center gap-2">
              <img
                src="assets/images/users/avatar-4.jpg"
                alt=""
                class="avatar-md rounded-circle"
              />
              <div>
                <h5 class="mb-0">Trần Thị B</h5>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2 mt-3 mb-1">
              <ul class="d-flex text-warning m-0 fs-20 list-unstyled">
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star"></i>
                </li>
                <li>
                  <i class="bx bxs-star-half"></i>
                </li>
              </ul>
              <p class="fw-medium mb-0 text-dark fs-15">Sản phẩm chất lượng</p>
            </div>

            <p class="mb-0 text-dark fw-medium fs-15">
              Đánh giá vào ngày 15/03/2024
            </p>
            <p class="text-muted mb-0">
              Xoài tươi ngon, giá cả hợp lý. Dịch vụ giao hàng chuyên nghiệp.
            </p>
            <p class="text-muted mb-0">Đã mua nhiều lần</p>

            <div class="mt-2">
              <a href="#!" class="fs-14 me-3 text-muted"
                ><i class="bx bx-like"></i> Hữu ích</a
              >
              <a href="#!" class="fs-14 text-muted">Báo cáo</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- End Container Fluid -->

  <!-- ========== Footer Start ========== -->
  <footer class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12 text-center">
          &copy; VNFarm. Crafted by
          <iconify-icon
            icon="iconamoon:heart-duotone"
            class="fs-18 align-middle text-danger"
          ></iconify-icon>
          <a href="#" class="fw-bold footer-text" target="_blank"
            >Hệ Thống Quản Lý Nông Sản VNFarm</a
          >
        </div>
      </div>
    </div>
  </footer>
  <!-- ========== Footer End ========== -->
</div>

<script type="module">
  import { BaseService } from "/custom/BaseService.js";
  import { EnumService } from "/custom/EnumService.js";
  import url from "/Custom/endpoints.js";
  import key from "/Custom/jwt.js";

  const jwt = key;

  
  const productUrl = url.base + "/Product";
  const enumService = new EnumService(url.baseUrl, jwt);

  const appProductDetail = {
    productId: null,
    unitTypes: {},
    isLoading: true,
    
    // Khởi tạo ứng dụng
    init: function() {
      this.productService = new BaseService(productUrl, jwt);
      this.enumService = enumService
      
      // Bắt đầu hiển thị loading
      this.toggleLoading(true);
      
      // Lấy id sản phẩm từ URL
      const urlParams = new URLSearchParams(window.location.search);
      this.productId = urlParams.get("id");
      
      if (!this.productId) {
        this.displayError("Không tìm thấy ID sản phẩm, vui lòng kiểm tra lại đường dẫn");
        this.toggleLoading(false);
        return;
      }
      
      // Tải dữ liệu đơn vị và thông tin sản phẩm
      this.loadUnitTypes();
    },
    
    // Hiển thị/ẩn trạng thái loading
    toggleLoading: function(isLoading) {
      this.isLoading = isLoading;
      const loadingIndicator = document.getElementById('loading-indicator');
      const productContent = document.getElementById('product-content');
      
      if (isLoading) {
        loadingIndicator.classList.remove('d-none');
        productContent.classList.add('d-none');
      } else {
        loadingIndicator.classList.add('d-none');
        productContent.classList.remove('d-none');
      }
    },
    
    // Tải danh sách các loại đơn vị
    loadUnitTypes: function() {
      const self = this;
      
      this.enumService.getUnitTypes()
        .then(function(data) {
          if (data) {
            console.log("Load Unit Types", data);
            self.unitTypes = data;
            self.loadProductDetails();
          }
        })
        .catch(function(error) {
          console.error("Lỗi khi lấy danh sách đơn vị:", error);
          self.loadProductDetails(); // Vẫn tiếp tục tải sản phẩm
        });
    },
    
    // Tải thông tin chi tiết sản phẩm
    loadProductDetails: function() {
      const self = this;
      this.productService.getById(this.productId)
        .then(function(response) {
          if (response && response.success && response.data) {
            console.log("Load Product Details", response.data);
            self.renderProductDetails(response.data);
            self.renderReviewLink(response.data);
          } else {
            self.displayError("Không thể tải thông tin sản phẩm: " + (response?.message || "Không rõ lỗi"));
          }
        })
        .catch(function(error) {
          console.error("Lỗi khi tải thông tin sản phẩm:", error);
          self.displayError("Đã xảy ra lỗi khi tải thông tin sản phẩm. Vui lòng thử lại sau.");
        })
        .finally(function() {
          // Ẩn loading khi hoàn thành
          self.toggleLoading(false);
        });
    },

    renderReviewLink: function(product) {
      const reviewLink = document.getElementById("review-link");
      if (reviewLink) {
        reviewLink.href = `/Admin/ProductReview?id=${product.id}`;
      }
    },
    
    // Hiển thị thông tin sản phẩm lên giao diện
    renderProductDetails: function(product) {
      // Cập nhật tiêu đề trang
      document.title = `Chi tiết sản phẩm - ${product.name}`;
      
      try {
        // Cập nhật hình ảnh sản phẩm
        this.updateProductImage(product);
        
        // Cập nhật thông tin cơ bản
        this.updateBasicInfo(product);
        
        // Cập nhật chi tiết sản phẩm
        this.updateProductDetails(product);
        
        // Cập nhật đánh giá
        this.renderReviews(product.reviews || []);
        
        // Cập nhật các nút hành động
        this.setupActionButtons(product);
      } catch (error) {
        console.error("Lỗi khi render chi tiết sản phẩm:", error);
      }
    },
    
    // Cập nhật hình ảnh sản phẩm
    updateProductImage: function(product) {
      // Tìm và cập nhật carousel
      const carouselContainer = document.querySelector(".card-body:has(.carousel)");
      
      if (carouselContainer && product.imageUrl) {
        // Xóa carousel cũ
        carouselContainer.innerHTML = "";
        
        // Tạo phần tử hình ảnh đơn giản
        const imageContainer = document.createElement("div");
        imageContainer.className = "text-center product-image-container";
        
        const image = document.createElement("img");
        image.src = url.baseUrl + "/img/Products/" + product.imageUrl;
        image.alt = product.name;
        
        image.alt = product.name;
        image.className = "img-fluid rounded p-2";
        image.style.maxHeight = "350px";
        image.onerror = function() {
          this.src = url.baseUrl + "/img/Products/no-image.webp";
        };
        
        imageContainer.appendChild(image);
        carouselContainer.appendChild(imageContainer);
      }
    },
    
    // Cập nhật thông tin cơ bản của sản phẩm
    updateBasicInfo: function(product) {
      // Cập nhật tên sản phẩm
      const productName = document.querySelector(".fs-24.text-dark.fw-medium");
      if (productName) {
        productName.textContent = product.name;
      }
      
      // Cập nhật giá sản phẩm
      const productPrice = document.querySelector("h2.fw-medium.my-3");
      if (productPrice) {
        productPrice.innerHTML = this.formatCurrency(product.price);
      }
      
      // Cập nhật đánh giá sao
      this.updateRatingStars(product.averageRating || 0);
      
      // Cập nhật số lượng đánh giá
      const ratingCount = document.querySelector(".fw-medium.fs-18.text-dark + .text-muted.fs-13");
      if (ratingCount) {
        ratingCount.textContent = `(${product.reviews?.length || 0} Đánh giá)`;
      }
      
      // Cập nhật xuất xứ
      const originText = document.querySelector("h5.text-dark.fw-medium span.text-muted");
      if (originText) {
        originText.textContent = product.origin || "Chưa cập nhật";
      }
      
      // Cập nhật đơn vị
      const unitText = document.querySelector(".col-lg-3 h5.text-dark.fw-medium span.text-muted");
      if (unitText && this.unitTypes[product.unit]) {
        unitText.textContent = this.unitTypes[product.unit];
      }
      
      // Cập nhật mô tả sản phẩm
      const productDescription = document.querySelector("#product-description");
      if (productDescription) {
        productDescription.textContent = product.description || "Chưa có mô tả chi tiết";
      }
      
      // Cập nhật trạng thái còn hàng
      const stockStatus = document.querySelector('ul.d-flex.flex-column.gap-2.list-unstyled.fs-15.my-3 li:first-child');
      if (stockStatus) {
        if (product.stockQuantity > 0) {
          stockStatus.innerHTML = '<i class="bx bx-check text-success"></i> Còn hàng';
        } else {
          stockStatus.innerHTML = '<i class="bx bx-x text-danger"></i> Hết hàng';
        }
      }
    },
    
    // Cập nhật hiển thị sao đánh giá
    updateRatingStars: function(rating) {
      const ratingStars = document.querySelectorAll(".text-warning.m-0.fs-20.list-unstyled li i");
      if (ratingStars.length > 0) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating - fullStars >= 0.5;
        
        for (let i = 0; i < ratingStars.length; i++) {
          if (i < fullStars) {
            ratingStars[i].className = "bx bxs-star";
          } else if (i === fullStars && hasHalfStar) {
            ratingStars[i].className = "bx bxs-star-half";
          } else {
            ratingStars[i].className = "bx bx-star";
          }
        }
      }
      
      // Cập nhật số điểm đánh giá
      const ratingScore = document.querySelector("#rating-count");
      console.log("Rating Score", ratingScore);
      console.log("Rating", rating);
      if (ratingScore && rating) {
        ratingScore.innerHTML = `${rating.toFixed(1)}`
      }
    },
    
    // Cập nhật chi tiết sản phẩm
    updateProductDetails: function(product) {
      const detailsList = document.querySelector(".d-flex.flex-column.gap-2.list-unstyled.fs-14.text-muted");
      if (!detailsList) return;
      
      // Xóa nội dung cũ
      detailsList.innerHTML = "";
      
      // Tạo danh sách thông tin chi tiết
      const details = [
        { label: "Mã sản phẩm", value: product.id },
        { label: "Ngày nhập kho", value: this.formatDate(product.createdAt) },
        { label: "Danh mục", value: product.category?.name || "Chưa phân loại" },
        { label: "Xuất xứ", value: product.origin || "Không có thông tin" },
        { label: "Đơn vị", value: this.unitTypes[product.unit] || "Không xác định" },
        { label: "Tồn kho", value: `${product.stockQuantity} ${this.unitTypes[product.unit] || "đơn vị"}` },
        { label: "Đã bán", value: `${product.totalSoldQuantity || product.soldQuantity || 0} ${this.unitTypes[product.unit] || "đơn vị"}` },
        { label: "Trạng thái", value: product.isActive ? "Đang bán" : "Ngừng bán" }
      ];
      
      // Thêm các mục vào danh sách
      details.forEach(item => {
        const listItem = document.createElement("li");
        listItem.innerHTML = `<span class="fw-medium text-dark">${item.label}</span><span class="mx-2">:</span>${item.value}`;
        detailsList.appendChild(listItem);
      });
    },
    
    // Hiển thị đánh giá của khách hàng
    renderReviews: function(reviews) {
      // Tìm container chứa đánh giá qua class card-review
      const reviewsContainer = document.querySelector('.card.card-review .card-body');
      
      if (!reviewsContainer) {
        console.error("Không tìm thấy container đánh giá");
        return;
      }
      
      // Xóa nội dung cũ
      reviewsContainer.innerHTML = "";
      
      // Kiểm tra có đánh giá không
      if (!reviews || reviews.length === 0) {
        reviewsContainer.innerHTML = `
          <div class="text-center text-muted my-4">
            <i class="bx bx-comment-x fs-1"></i>
            <p class="mt-2">Sản phẩm chưa có đánh giá nào</p>
          </div>
        `;
        return;
      }
      
      // Lặp qua từng đánh giá
      reviews.forEach((review, index) => {
        const reviewElement = document.createElement("div");
        
        reviewElement.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <div class="avatar-md rounded-circle bg-light d-flex align-items-center justify-content-center">
              <i class="bx bx-user fs-22 text-primary"></i>
            </div>
            <div>
              <h5 class="mb-0">Khách hàng #${review.userId}</h5>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2 mt-3 mb-1">
            <ul class="d-flex text-warning m-0 fs-20 list-unstyled">
              ${this.generateRatingStarsHTML(review.rating)}
            </ul>
            <p class="fw-medium mb-0 text-dark fs-15">${review.content?.substring(0, 20) || "Đánh giá sản phẩm"}</p>
          </div>
          <p class="mb-0 text-dark fw-medium fs-15">Đánh giá vào ngày ${this.formatDate(review.createdAt)}</p>
          <p class="text-muted">${review.content || "Không có nội dung đánh giá"}</p>
          ${review.imageUrl ? `
            <div class="my-2">
              <img id="review-image" src="${url.baseUrl}/img/Reviews/${review.imageUrl}" alt="Hình ảnh đánh giá" class="img-fluid rounded" style="max-height: 120px;" onerror="this.src='/custom/no-image.webp'">
            </div>
          ` : ''}
          ${review.shopResponse ? `
            <div class="bg-light-subtle p-3 rounded my-2">
              <p class="mb-1 fw-medium"><i class="bx bx-store-alt me-1 text-primary"></i> Phản hồi từ shop:</p>
              <p class="mb-0 text-muted">${review.shopResponse}</p>
            </div>
          ` : ''}
        `;
        
        reviewsContainer.appendChild(reviewElement);
        
        // Thêm đường kẻ nếu không phải đánh giá cuối cùng
        if (index < reviews.length - 1) {
          const hr = document.createElement("hr");
          hr.className = "my-3";
          reviewsContainer.appendChild(hr);
        }
      });
    },
    
    // Thiết lập các nút hành động
    setupActionButtons: function(product) {
      // Nút chỉnh sửa sản phẩm
      const editButton = document.querySelector(".card-footer .btn-primary");
      if (editButton) {
        // Xóa event listener cũ (nếu có)
        const newEditButton = editButton.cloneNode(true);
        editButton.parentNode.replaceChild(newEditButton, editButton);
        
        // Thêm event listener mới
        newEditButton.addEventListener("click", () => {
          window.location.href = `/Admin/ProductEdit?id=${product.id}`;
        });
      }
    },
    
    // Hiển thị thông báo lỗi
    displayError: function(message) {
      const pageContent = document.querySelector(".page-content");
      if (pageContent) {
        // Ẩn loading indicator
        this.toggleLoading(false);
        
        // Thay đổi nội dung trang thành thông báo lỗi
        const productContent = document.getElementById('product-content');
        productContent.innerHTML = `
          <div class="row">
            <div class="col-md-12">
              <div class="alert alert-danger my-4" role="alert">
                <div class="d-flex">
                  <div class="flex-shrink-0">
                    <i class="bx bx-error-circle display-6 text-danger"></i>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h4 class="alert-heading">Đã xảy ra lỗi!</h4>
                    <p class="mb-0">${message}</p>
                    <hr>
                    <p class="mb-0">
                      <button class="btn btn-outline-danger btn-sm" onclick="history.back()">
                        <i class="bx bx-arrow-back me-1"></i> Quay lại
                      </button>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Hiển thị container để hiện thông báo lỗi
        productContent.classList.remove('d-none');
      } else {
        alert(message);
      }
    },
    
    // Tạo HTML hiển thị đánh giá sao
    generateRatingStarsHTML: function(rating) {
      let starsHTML = "";
      for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
          starsHTML += '<li><i class="bx bxs-star"></i></li>';
        } else {
          starsHTML += '<li><i class="bx bx-star"></i></li>';
        }
      }
      return starsHTML;
    },
    
    // Định dạng ngày tháng
    formatDate: function(dateString) {
      if (!dateString) return "N/A";
      const date = new Date(dateString);
      return date.toLocaleDateString("vi-VN", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    },
    
    // Định dạng tiền tệ
    formatCurrency: function(amount) {
      return new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND"
      }).format(amount);
    }
  };
  
  // Khởi động ứng dụng
  appProductDetail.init();
</script>
