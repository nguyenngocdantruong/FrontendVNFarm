@{
    Layout = "_LayoutSeller";
    ViewBag.Title = "Tin nhắn";
}

<main class="nxl-container">
    <div class="nxl-content">
        <!-- [ page-header ] start -->
        <div class="page-header">
            <div class="page-header-left d-flex align-items-center">
                <div class="page-header-title">
                    <h5 class="m-b-10">Tin nhắn với khách hàng</h5>
                </div>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/Seller/Index">Trang chủ</a></li>
                    <li class="breadcrumb-item">Tin nhắn</li>
                </ul>
            </div>
        </div>
        <!-- [ page-header ] end -->

        <!-- [ Main Content ] start -->
        <div class="main-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="row g-0" style="height: calc(100vh - 220px); min-height: 500px;">
                                <!-- Danh sách người chat -->
                                <div class="col-md-3 border-end" style="height: 100%; overflow-y: auto;">
                                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0 fs-16">Khách hàng</h5>
                                    </div>

                                    <div class="list-group list-group-flush" id="chat-customers">
                                        <!-- Danh sách khách hàng sẽ được thêm vào đây -->
                                        <div class="text-center p-3" id="loading-customers">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Đang tải...</span>
                                            </div>
                                            <p class="mt-2">Đang tải danh sách khách hàng...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Khung chat -->
                                <div class="col-md-9" style="height: 100%;">
                                    <div id="chat-container" style="display: flex; flex-direction: column; height: 100%;">
                                        <div id="chat-header" class="p-3 border-bottom">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <div id="chat-avatar" class="me-3">
                                                        <img src="/Custom/no-image.webp" alt="Avatar" class="rounded-circle" width="40"
                                                            height="40">
                                                    </div>
                                                    <div>
                                                        <h6 id="chat-name" class="mb-0">Đang tải...</h6>
                                                        <small id="chat-status" class="text-muted"></small>
                                                    </div>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                        id="connectionStatus">
                                                        <i class="feather-wifi text-warning"></i> Đang kết nối...
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px;">
                                            <!-- Tin nhắn sẽ được thêm vào đây -->
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Đang tải...</span>
                                                </div>
                                                <p class="mt-2">Đang tải tin nhắn...</p>
                                            </div>
                                        </div>

                                        <div id="typing-indicator" class="px-3 py-2 text-muted small d-none">
                                            <span>Khách hàng đang nhập...</span>
                                        </div>

                                        <div id="chat-input" class="p-3 border-top">
                                            <form id="message-form" class="mb-0">
                                                <div class="input-group">
                                                    <input type="text" id="message-input" class="form-control"
                                                        placeholder="Nhập tin nhắn..." autocomplete="off">
                                                    <button class="btn btn-primary" type="submit">
                                                        <i class="feather-send"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</main>

<!-- Modal tin nhắn mẫu -->
<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateModalLabel">Chọn tin nhắn mẫu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group" id="template-list">
                    <button type="button" class="list-group-item list-group-item-action"
                        data-template="Chào bạn, cảm ơn bạn đã liên hệ với chúng tôi. Chúng tôi có thể giúp gì cho bạn?">
                        Lời chào
                    </button>
                    <button type="button" class="list-group-item list-group-item-action"
                        data-template="Cảm ơn bạn đã đặt hàng tại cửa hàng chúng tôi. Đơn hàng của bạn đang được xử lý và sẽ sớm được giao.">
                        Xác nhận đơn hàng
                    </button>
                    <button type="button" class="list-group-item list-group-item-action"
                        data-template="Chúng tôi rất tiếc về sự bất tiện này. Vui lòng cho chúng tôi biết chi tiết vấn đề bạn gặp phải để chúng tôi có thể hỗ trợ bạn tốt nhất.">
                        Xử lý khiếu nại
                    </button>
                    <button type="button" class="list-group-item list-group-item-action"
                        data-template="Hiện tại sản phẩm này đã hết hàng. Chúng tôi sẽ thông báo cho bạn ngay khi có hàng trở lại.">
                        Thông báo hết hàng
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="create-new-template">Tạo mẫu mới</button>
            </div>
        </div>
    </div>
</div>

<!-- Thêm thư viện Pusher -->
<script src="https://js.pusher.com/8.3.0/pusher.min.js"></script>

<script type="module">
    import url from "/Custom/endpoints.js";

    // Lấy thông tin từ localStorage
    const token = localStorage.getItem('accessToken');
    const storeId = localStorage.getItem('storeId');

    // Biến toàn cục
    let currentRoomId = null;
    let currentCustomerId = null;
    let currentRoomInfo = null;
    let pusher = null;
    let channel = null;

    // Hàm tải danh sách phòng chat
    function loadChatRooms() {
        if (!token || !storeId) {
            Toast.error("Không tìm thấy thông tin đăng nhập. Vui lòng đăng nhập lại.");
            return;
        }

        document.getElementById('loading-customers').style.display = 'block';

        app.services.chat.fetchApi("/my-chats")
            .then(response => {
                if (response && Array.isArray(response) && response.length > 0) {
                    // Hiển thị danh sách phòng
                    renderChatRooms(response);

                    // Nếu không có room ID trong URL, tự động chọn phòng đầu tiên
                    if (!currentRoomId) {
                        const firstRoom = response[0];
                        currentRoomId = firstRoom.id;

                        // Chuyển hướng URL để có room ID
                        const newUrl = window.location.pathname + '?room=' + currentRoomId;
                        window.history.pushState({ path: newUrl }, '', newUrl);

                        // Tải thông tin phòng chat
                        loadRoomInfo(currentRoomId);
                    }
                } else {
                    document.getElementById('chat-customers').innerHTML = '<div class="text-center p-3">Không có cuộc trò chuyện nào</div>';
                    document.getElementById('loading-customers').style.display = 'none';

                    // Hiển thị thông báo không có cuộc trò chuyện
                    document.getElementById('chat-messages').innerHTML = `
                        <div class="text-center py-4">
                            <i class="feather-message-circle" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="mt-3 text-muted">Bạn chưa có cuộc trò chuyện nào. Hãy chờ khách hàng liên hệ.</p>
                        </div>
                    `;
                    
                    // Vô hiệu hóa khung nhập tin nhắn
                    document.getElementById('message-input').disabled = true;
                    document.getElementById('message-form').querySelector('button[type="submit"]').disabled = true;
                    
                    // Cập nhật tiêu đề
                    document.getElementById('chat-name').textContent = 'Không có cuộc trò chuyện';
                    document.getElementById('chat-status').textContent = '';
                }
            })
            .catch(error => {
                console.error("Lỗi khi tải danh sách phòng chat:", error);
                Toast.error("Không thể tải danh sách phòng chat");
                document.getElementById('loading-customers').style.display = 'none';
                
                // Hiển thị thông báo lỗi trong khung chat
                document.getElementById('chat-messages').innerHTML = `
                    <div class="text-center py-4">
                        <i class="feather-alert-circle" style="font-size: 3rem; color: #dc3545;"></i>
                        <p class="mt-3 text-danger">Không thể tải danh sách phòng chat. Vui lòng thử lại sau.</p>
                    </div>
                `;
            });
    }

    // Hàm hiển thị danh sách phòng chat
    function renderChatRooms(chatRooms) {
        const customersContainer = document.getElementById('chat-customers');
        document.getElementById('loading-customers').style.display = 'none';

        if (!Array.isArray(chatRooms) || chatRooms.length === 0) {
            customersContainer.innerHTML = '<div class="text-center p-3">Không có cuộc trò chuyện nào</div>';
            return;
        }

        let html = '';
        chatRooms.forEach(room => {
            // Định dạng thời gian
            const lastMessageTime = new Date(room.lastMessageTime);
            const now = new Date();
            let timeDisplay = '';

            if (lastMessageTime.toDateString() === now.toDateString()) {
                timeDisplay = lastMessageTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            } else {
                timeDisplay = lastMessageTime.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            }

            // Đánh dấu phòng được chọn
            const isActive = room.id == currentRoomId ? 'active' : '';
            
            // Lấy thông tin người mua từ đối tượng buyer
            const buyerName = room.buyer?.fullName || 'Khách hàng';
            const buyerImage = room.buyer?.imageUrl ? `${url.baseUrl}/img/Users/${room.buyer.imageUrl}` : '/Custom/no-image.webp';

            html += `
                <a href="?room=${room.id}" class="list-group-item list-group-item-action chat-customer ${isActive}" 
                   data-room-id="${room.id}" data-room-name="${room.nameRoom}">
                    <div class="d-flex align-items-center">
                        <div class="position-relative me-3">
                            <img src="${buyerImage}" alt="${buyerName}" class="rounded-circle" width="40" height="40">
                        </div>
                        <div class="flex-grow-1 min-width-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate">${buyerName}</h6>
                                <small class="text-muted ms-2">${timeDisplay}</small>
                            </div>
                            <p class="text-muted mb-0 small text-truncate">${room.lastMessage || 'Không có tin nhắn'}</p>
                        </div>
                    </div>
                </a>
            `;
        });

        customersContainer.innerHTML = html;

        // Sự kiện click cho các phòng chat
        document.querySelectorAll('.chat-customer').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const roomId = this.getAttribute('data-room-id');

                // Cập nhật URL
                const newUrl = window.location.pathname + '?room=' + roomId;
                window.history.pushState({ path: newUrl }, '', newUrl);

                // Đánh dấu mục đang chọn
                document.querySelectorAll('.chat-customer').forEach(el => {
                    el.classList.remove('active');
                });
                this.classList.add('active');

                // Tải thông tin phòng
                currentRoomId = roomId;
                loadRoomInfo(roomId);
            });
        });
    }

    // Hàm tải thông tin phòng chat
    function loadRoomInfo(roomId) {
        if (!roomId) return;

        // Hiển thị khung chat với trạng thái đang tải
        document.getElementById('chat-messages').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-2">Đang tải tin nhắn...</p>
            </div>
        `;

        // Gọi API để lấy thông tin phòng chat
        app.services.chat.fetchApi(`/room/${roomId}`)
            .then(response => {
                if (response) {
                    currentRoomInfo = response;
                    currentCustomerId = response.buyerId;

                    // Cập nhật giao diện với thông tin phòng chat
                    updateUIWithRoomInfo(response);

                    // Kết nối Pusher
                    connectToPusher(roomId);
                    
                    // Bật các nút điều khiển
                    document.getElementById('message-input').disabled = false;
                    document.getElementById('message-form').querySelector('button[type="submit"]').disabled = false;
                } else {
                    Toast.error("Không thể tải thông tin phòng chat");
                }
            })
            .catch(error => {
                console.error("Lỗi khi tải thông tin phòng chat:", error);
                Toast.error("Không thể tải thông tin phòng chat");
            });
    }

    // Hàm cập nhật giao diện
    function updateUIWithRoomInfo(roomData) {
        const buyer = roomData.buyer;
        if (buyer) {
            document.getElementById('chat-name').textContent = buyer.fullName || 'Khách hàng';
            document.getElementById('chat-avatar').querySelector('img').src = `${url.baseUrl}/img/Users/${buyer.imageUrl}`;
            document.getElementById('chat-status').textContent = roomData.isActive ? 'Trực tuyến' : 'Offline';
        } else {
            document.getElementById('chat-name').textContent = roomData.nameRoom || 'Phòng chat';
            document.getElementById('chat-status').textContent = '';
        }

        // Hiển thị tin nhắn
        app.services.chat.fetchApi(`/room/${roomData.id}/messages`)
        .then(response => {
            if (Array.isArray(response) && response.length > 0) {
                displayMessages(response);
            } else {
                document.getElementById('chat-messages').innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện!</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error("Lỗi khi tải tin nhắn:", error);
            Toast.error("Không thể tải tin nhắn");
        });
    }

    // Hàm hiển thị danh sách tin nhắn
    function displayMessages(messages) {
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = '';

        if (!Array.isArray(messages) || messages.length === 0) {
            messagesContainer.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted">Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện!</p>
                </div>
            `;
            return;
        }

        // Sắp xếp tin nhắn theo thời gian (cũ nhất lên trên)
        messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

        // Hiển thị từng tin nhắn
        messages.forEach(msg => {
            if (!msg.content) return; // Bỏ qua tin nhắn rỗng
            
            const isFromCustomer = msg.senderId === currentCustomerId;
            let dt = new Date(msg.createdAt);
            dt.setHours(dt.getHours() + 7);
            const messageTime = dt.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            appendMessage(msg.content, isFromCustomer, messageTime);
        });

        // Cuộn xuống tin nhắn mới nhất
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Hàm kết nối đến Pusher
    function connectToPusher(roomId) {
        // Ngắt kết nối kênh cũ nếu có
        if (channel) {
            channel.unbind_all();
            pusher.unsubscribe(roomId);
        }

        // Khởi tạo Pusher nếu chưa có
        if (!pusher) {
            pusher = new Pusher("8edd0b50c3ce30916549", {
                cluster: "ap1",
            });
        }
        
        // Chuyển đổi roomId thành chuỗi để đảm bảo tương thích với Pusher
        const channelName = roomId.toString();
        console.log("Đăng ký kênh Pusher:", channelName);
        
        // Đăng ký kênh và sự kiện
        channel = pusher.subscribe(channelName);

        // Cập nhật trạng thái kết nối
        document.getElementById('connectionStatus').innerHTML = '<i class="feather-wifi text-success"></i> Đã kết nối';

        // Lắng nghe sự kiện tin nhắn mới
        channel.bind("new-message", function(data) {
            console.log("Nhận được tin nhắn mới:", data);

            // Xử lý tin nhắn nhận được
            if (data && data.message) {
                const isFromCustomer = data.senderId === currentCustomerId;
                appendMessage(data.message, isFromCustomer);
                
                // Cuộn xuống tin nhắn mới nhất
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });

        // Xử lý lỗi kết nối
        pusher.connection.bind('error', function(err) {
            console.error("Lỗi kết nối Pusher:", err);
            document.getElementById('connectionStatus').innerHTML = '<i class="feather-wifi-off text-danger"></i> Lỗi kết nối';
            Toast.error("Không thể kết nối đến máy chủ chat");
        });
    }

    // Hàm gửi tin nhắn
    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();

        if (!message || !currentRoomId) {
            return;
        }

        // Hiển thị tin nhắn ngay lập tức (optimistic UI)
        // appendMessage(message, false);
        
        // Xóa nội dung input ngay sau khi hiển thị
        messageInput.value = '';

        let urlSend = `/room/${currentRoomId}/send`;

        // Gọi API để gửi tin nhắn
        app.services.chat.fetchApi(urlSend, 'POST', message)
        .then(() => {
            console.log("Đã gửi tin nhắn thành công");
        })
        .catch(err => {
            console.error("Lỗi khi gửi tin nhắn:", err);
            Toast.error("Không thể gửi tin nhắn");
        });
    }

    // Hàm thêm tin nhắn vào khung chat
    function appendMessage(content, isFromCustomer, time = null) {
        if (!content) return;
        
        const messagesContainer = document.getElementById('chat-messages');
        let messageTime = '';
        
        if (!time) {
            const now = new Date();
            messageTime = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        } else {
            messageTime = time;
        }

        const messageElement = document.createElement('div');
        messageElement.className = `message ${isFromCustomer ? 'message-received' : 'message-sent'} mb-3`;
        messageElement.innerHTML = `
            <div class="message-content p-3 rounded ${isFromCustomer ? 'bg-light' : 'bg-primary text-white'}">
                <p class="mb-0">${content}</p>
            </div>
            <div class="message-time small text-muted ${isFromCustomer ? '' : 'text-end'} mt-1">${messageTime}</div>
        `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Cập nhật tin nhắn cuối cùng - đây là phần gây lỗi
        // Kiểm tra xem có phần tử .last-msg không trước khi cập nhật
        const lastMessage = document.querySelector('.last-msg');
        if (lastMessage) {
            lastMessage.textContent = content;
        }
    }

    // Lấy room ID từ URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const roomParam = urlParams.get('room');

    // Luôn tải danh sách phòng chat trước
    loadChatRooms();

    if (roomParam) {
        // Nếu có room ID trong URL, kết nối trực tiếp đến phòng đó
        currentRoomId = roomParam;
        loadRoomInfo(currentRoomId);
    }

    // Xử lý gửi tin nhắn
    document.getElementById('message-form').addEventListener('submit', function (e) {
        e.preventDefault();
        sendMessage();
    });
</script>

<style>
    /* CSS cho khung chat */
    .message {
        max-width: 80%;
        margin-bottom: 15px;
    }

    .message-received {
        margin-right: auto;
    }

    .message-sent {
        margin-left: auto;
    }

    .message-content {
        border-radius: 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .message-sent .message-content {
        border-top-right-radius: 5px;
    }

    .message-received .message-content {
        border-top-left-radius: 5px;
    }

    .chat-customer {
        transition: all 0.2s ease;
        padding: 10px 15px;
    }

    .chat-customer:hover,
    .chat-customer.active {
        background-color: #f8f9fa;
    }

    .chat-customer.active {
        border-left: 3px solid #0d6efd;
    }

    .chat-customer .text-truncate {
        max-width: 150px;
    }

    #chat-search {
        border-radius: 20px;
    }

    #chat-header {
        background-color: #f8f9fa;
    }

    #chat-input {
        background-color: #f8f9fa;
    }

    #chat-input .btn {
        border-radius: 50%;
        padding: 8px 10px;
    }

    #chat-input .form-control {
        border-radius: 20px;
    }

    /* Phần tùy chỉnh cuộn */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>