@{
    ViewData["Title"] = "Qu√™n m·∫≠t kh·∫©u";
    ViewBag.Title = "Qu√™n m·∫≠t kh·∫©u";
}

<!-- BREADCRUMB AREA START -->
    <div class="ltn__breadcrumb-area ltn__breadcrumb-area-2 ltn__breadcrumb-color-white bg-overlay-theme-black-90 bg-image" data-bg="/img/bg/9.jpg">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="ltn__breadcrumb-inner ltn__breadcrumb-inner-2 justify-content-between">
                        <div class="section-title-area ltn__section-title-2">
                            <h1 class="section-title white-color">Qu√™n m·∫≠t kh·∫©u</h1>
                        </div>
                        <div class="ltn__breadcrumb-list">
                            <ul>
                                <li><a href="/">Trang ch·ªß</a></li>
                                <li>Qu√™n m·∫≠t kh·∫©u</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- BREADCRUMB AREA END -->

    <!-- FORGOT PASSWORD AREA START -->
    <div class="ltn__login-area pb-65">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-title-area text-center">
                        <h1 class="section-title">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h1>
                        <p id="formDescription">Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ nh·∫≠n h∆∞·ªõng d·∫´n ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u</p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 offset-lg-3">
                    <div class="account-login-inner">
                        <form id="formForgotPassword" method="post" class="ltn__form-box contact-form-box">
                            <input type="text" name="email" placeholder="Email c·ªßa b·∫°n*" required>
                            <div class="go-to-btn mt-20 text-center">
                                <button class="theme-btn-1 btn btn-block" type="submit">ƒê·∫∂T L·∫†I M·∫¨T KH·∫®U üîê</button>
                            </div>
                            <div class="go-to-btn mt-20 text-center">
                                <a class="btn btn-primary" asp-action="Login" asp-controller="Home"><small>QUAY L·∫†I TRANG ƒêƒÇNG NH·∫¨P</small></a>
                            </div>
                        </form>
                        
                        <form id="formResetPassword" method="post" class="ltn__form-box contact-form-box" style="display: none;">
                            <input type="text" name="email" placeholder="Email c·ªßa b·∫°n*" required>
                            <input type="text" name="resetPasswordToken" placeholder="M√£ OTP ƒë√£ g·ª≠i ƒë·∫øn email*" required>
                            <input type="password" name="newPassword" placeholder="M·∫≠t kh·∫©u m·ªõi*" required>
                            <div class="go-to-btn mt-20 text-center">
                                <button class="theme-btn-1 btn btn-block" type="submit">X√ÅC NH·∫¨N ƒê·∫∂T L·∫†I M·∫¨T KH·∫®U üîí</button>
                            </div>
                            <div class="go-to-btn mt-20 text-center">
                                <a class="btn btn-primary" asp-action="Login" asp-controller="Home"><small>QUAY L·∫†I TRANG ƒêƒÇNG NH·∫¨P</small></a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FORGOT PASSWORD AREA END -->
    <script type="module">
        import Toast from "/Custom/Toast.js";
        import {BaseService} from "/Custom/BaseService.js";
        import url from "/Custom/endpoints.js"

        const authUrl = url.base + "/Auth";
        const authService = new BaseService(authUrl, null);
        let userEmail = "";

        document.getElementById("formForgotPassword").addEventListener("submit", function(event) {
            event.preventDefault();
            const email = this.email.value;
            userEmail = email;
            
            if (!email) {
                Toast.error("Vui l√≤ng nh·∫≠p email");
                return;
            }
            
            authService.fetchApi("/ForgotPassword", 'POST', {Email: email})
            .then(response => {
                if (response.status === 200) {
                    Toast.success(response.message);
                    showResetPasswordForm(email);
                } else {
                    Toast.error(response.message);
                }
            })
            .catch(error => {
                Toast.error(error.message)
            })
        });
        
        document.getElementById("formResetPassword").addEventListener("submit", function(event) {
            event.preventDefault();
            const email = this.email.value;
            const resetPasswordToken = parseInt(this.resetPasswordToken.value);
            const newPassword = this.newPassword.value;
            
            if (!email || !resetPasswordToken || !newPassword) {
                Toast.error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin");
                return;
            }
            
            const resetData = {
                Email: email,
                OTP: resetPasswordToken,
                NewPassword: newPassword
            };
            
            authService.fetchApi("/ResetPassword", 'POST', resetData)
            .then(response => {
                if (response.status === 200) {
                    Toast.success(response.message);
                    setTimeout(() => {
                        window.location.href = "/Home/Login";
                    }, 2000);
                } else {
                    Toast.error(response.message);
                }
            })
            .catch(error => {
                Toast.error(error.message)
            })
        });
        
        function showResetPasswordForm(email) {
            document.getElementById("formDescription").textContent = "Vui l√≤ng nh·∫≠p m√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n";
            document.getElementById("formForgotPassword").style.display = "none";
            const resetForm = document.getElementById("formResetPassword");
            resetForm.style.display = "block";
            resetForm.email.value = email;
        }
    </script>